var SNormal="Normal";var SLow="Low!";function TAssetTag(){this.tagId=0;this.assetId="";this.timestamp="";this.x=0;this.y=0;this.battery=SNormal;this.element=newElement(SDiv,"TAssetEntity");this.element.appendChild(newElement(SDiv,"TMarkerIcon"))}TAssetTag.prototype={draw:function(b){var a=this.element;a.style.left=(this.x*b-12)+SPixel;a.style.top=(this.y*b-a.offsetHeight)+SPixel},toArray:function(){return[this.tagId,this.assetId,this.timestamp,this.x,this.y,this.battery]},toHtml:function(){return'<table cellspacing="0" style="border-collapse: collapse;"><tr><td>Tag ID</td><td>:</td><td class="TTagId">'+this.tagId+"</td></tr><tr><td>Asset ID</td><td>:</td><td>"+this.assetId+"</td></tr><tr><td>Battery</td><td>:</td><td>"+this.battery+"</td></tr></table>"}};function TCellList(){var l=this;var c=newElement("div","TCellList");var i="TListItem";var k="TFocusedItem";var o="TSelectedItem";var p="TMatchedString";var n;var m="";var e=-1;var r=-1;var s=null;var v=false;this.autoHide=false;this.caseSensitive=false;this.showIndex=false;this.clearTextBoxOnExit=false;this.maxDisplayedItemCount=5;this.onChanged=null;this.onHoverChanged=null;this.getElement=function(){return c};this.getSelectedIndex=function(){return e};this.getFocusedIndex=function(){return r};this.getItems=function(){return n};this.setItems=function(w,x){if(n!=w){n=w;var z="";var A=-1;if(n){A=n.length-1;if(x){for(var y=A;y>=0;y--){z+=d(A-y,n[y].toString())}}else{for(var y=0;y<=A;y++){z+=d(y,n[y].toString())}}}c.innerHTML=z;for(var y=A;y>=0;y--){z=c.childNodes[y];z.onclick=g;z.onmouseout=q;z.onmouseover=u}if(l.maxDisplayedItemCount>0){c.style.height=z.offsetHeight*l.maxDisplayedItemCount+SPixel}else{c.style.height=SAuto}}};function d(w,y){var x="";if(l.showIndex){x='<div class="TListItemIndex">'+(w+1)+"</div>"}return'<div id="'+w+'" class="TListItem">'+x+'<div class="TListItemText">'+y+"</div></div>"}this.attachTextBox=function(w){if(s!=w){if(s){s.removeEventListener(SFocus,t,false);s.removeEventListener(SKeyDown,a,false);s.removeEventListener(SKeyUp,b,false);document.addEventListener(SClick,f,false)}if(w){w.addEventListener(SFocus,t,false);w.addEventListener(SKeyDown,a,false);w.addEventListener(SKeyUp,b,false);document.addEventListener(SClick,f,false);c.style.width=w.offsetWidth-10+SPixel}s=w}};this.setMatchString=function(w){if(m!=w){m=w;l.invalidate()}};function h(x){var w=x.offsetTop-c.clientTop;if(w<c.scrollTop){c.scrollTop=w}else{w+=x.offsetHeight-c.clientHeight;if(w>c.scrollTop){c.scrollTop=w}}}this.setSelectedIndex=function(x){if(e!=x){if(e>-1){c.childNodes[e].className=i}if(x>-1){var w=c.childNodes[x];w.className=o;h(w)}e=x;if(l.onChanged){l.onChanged()}}};this.setFocusedIndex=function(x){if(r!=x){if(r>-1){var w=c.childNodes[r];if(w.id!=e){w.className=i}else{w.className=o}}if(x>-1){var w=c.childNodes[x];if(w.id!=e){w.className=k}h(w)}r=x;if(l.onHoverChanged){l.onHoverChanged()}}};this.invalidate=function(){l.setFocusedIndex(-1);var B=(m==null)||(m=="");var A='<span class="'+p+'">';var E="</span>";var z=false;var x=l.caseSensitive?"":"i";var F=new RegExp(m,x);var D;var G=0;if(l.showIndex){G=1}for(var C=c.childNodes.length-1;C>=0;C--){var H=n[C].toString();var w=c.childNodes[C];var y=w.childNodes[G];y.innerHTML=H;if(B==false){D=H.match(F);if(D){y.innerHTML=H.replace(D[0],A+D[0]+E);w.style.display=SBlock;z=true}else{w.style.display=SNone}}else{w.style.display=SBlock;z=true}}c.scrollTop=0;if(!z&&l.autoHide){c.style.visibility=SHidden}};this.focusNextItem=function(y){var w=c.childNodes;var x=-1;if(r>=0&&w[r].style.display!=SNone){x=r}if(y>0){do{x++}while((x<w.length)&&(w[x].style.display==SNone));if(x==w.length){x=-1}}else{if(x==-1){x=w.length}do{x--}while((x>-1)&&(w[x].style.display==SNone))}l.setFocusedIndex(x)};function g(w){l.setSelectedIndex(this.id);w.preventDefault()}function q(w){l.setFocusedIndex(-1);w.preventDefault()}function u(w){l.setFocusedIndex(this.id);w.preventDefault()}function t(){c.style.visibility=SVisible}function j(){if(s){if(l.clearTextBoxOnExit){s.value=""}else{if(e>-1){s.value=n[e].toString()}}}if(l.autoHide){c.style.visibility=SHidden}}function a(w){t();v=false;switch(w.keyCode){case 13:l.setSelectedIndex(r);j();break;case 38:case 40:l.focusNextItem(w.keyCode-39);if(r>-1){this.value=n[r].toString()}else{this.value=m}break;case 9:case 27:j();break;default:l.setMatchString(this.value);return}v=true}function b(w){if(!v){l.setMatchString(this.value)}}function f(w){if(w.target==s){l.setMatchString(s.value);t()}else{if(w.target==c){t()}else{j()}}}};var SPost="POST";var SGet="GET";var SDiv="div";var SUndefined="undefined";var SIndexOutOfRange="Index out of range: ";var SAuto="auto";var SPixel="px";var SNone="none";var SBlock="block";var SInline="inline";var SHidden="hidden";var SVisible="visible";var SFocus="focus";var SBlur="blur";var SKeyDown="keydown";var SKeyUp="keyup";var SClick="click";var SMouseDown="mousedown";var SMouseMove="mousemove";var SMouseOut="mouseout";var SMouseOver="mouseover";var SMouseUp="mouseup";var SMouseWheel="mousewheel";var csLoading=0;var csLoaded=1;var browser={isIE:navigator.userAgent.indexOf("MSIE")>-1,isChrome:navigator.userAgent.indexOf("Chrome")>-1,isFirefox:navigator.userAgent.indexOf("Firefox")>-1};function newElement(b,c){var a=document.createElement(b);if(a){a.className=c}return a}function $(a){return document.getElementById(a)}function isZero(a,b){return Math.abs(a)<b}function isInRange(b,c,a){return(b>=c&&b<=a)}function checkRange(b,c,a){if(!isInRange(b,c,a)){throw SIndexOutOfRange+b}}function ensureRange(b,c,a){if(b<c){return c}if(b>a){return a}return b};var cnTFlexTable="TFlexTable";var cnFocusedRow="Focused";var cnSelectedRow="Selected";var cnMatchedString="TMatchedString";var STableRow="table-row";function TFlexTable(j){var o=this;var r=newElement("table",cnTFlexTable);j.appendChild(r);var q=r.rows;var k=0;var p=0;var e;var m=-1;var n="";var c=false;var f=-1;var l=-1;var i=null;function s(w){var v=w.offsetTop-r.clientTop;if(v<r.scrollTop){r.scrollTop=v}else{v+=w.offsetHeight-r.clientHeight;if(v>r.scrollTop){r.scrollTop=v}}}this.focusNextRow=function(w){var v=-1;if((l>-1)&&(q[l].style.display!=SNone)){v=l}if(w>0){do{v++}while((v<q.length)&&(q[v].style.display==SNone));if(v==q.length){v=-1}}else{if(v==-1){v=q.length}do{v--}while((v>-1)&&(q[v].style.display==SNone))}o.setFocusedIndex(v)};function u(v){o.setSelectedIndex(this.rowIndex);v.preventDefault()}function t(v){o.setFocusedIndex(-1);v.preventDefault()}function h(v){o.setFocusedIndex(this.rowIndex);v.preventDefault()}function a(v){if(this.__readonly){return}}function g(){o.filter(-1,this.value)}function b(v){c=false;switch(v.keyCode){case 13:o.setSelectedIndex(l);break;case 38:case 40:o.focusNextRow(v.keyCode-39);if(l>-1){if(browser.isChrome||browser.isIE){this.value=q[l].cells[m].innerText}}else{this.value=n}break;case 9:case 27:if(o.autoClearTextBox){this.value="";o.filter(-1,"")}break;default:c=true}}function d(v){if(c){o.filter(-1,this.value)}}this.getColumnCount=function(){if(q.length>0){return q[0].cells.length}return 0};this.getRowCount=function(){return q.length};this.getElement=function(){return r};this.getFocusedIndex=function(){return l};this.getFocusedRow=function(){if(l>-1){return q[l]}return null};this.getSelectedIndex=function(){return f};this.getSelectedRow=function(){if(f>-1){return q[f]}return null};this.setMaxRowCount=function(w){var v=SAuto;if(w>0){v=w*q[0].offsetHeight+SPixel}r.style.maxHeight=v};this.setFocusedIndex=function(v){if(l!=v){if(l>-1){var w=q[l];if(w.rowIndex!=f){w.className=""}}if(v>-1&&v<q.length){var w=q[v];if(w.rowIndex!=f){w.className=cnFocusedRow}s(w);l=v}else{l=-1}if(o.onFocusChange){o.onFocusChange()}}};this.setSelectedIndex=function(v){if(f!=v){if((f>-1)&&(f<q.length)){q[f].className=""}if(v>-1&&v<q.length){var w=q[v];w.className=cnSelectedRow;s(w);f=v}else{f=-1}if(o.onSelectChange){o.onSelectChange()}}};this.attachTextBox=function(w,v){m=v;if(i!=w){if(i){i.removeEventListener(SFocus,g,false);i.removeEventListener(SKeyUp,d,false);i.removeEventListener(SKeyDown,b,false)}if(w){w.addEventListener(SFocus,g,false);w.addEventListener(SKeyUp,d,false);w.addEventListener(SKeyDown,b,false)}i=w}};this.filter=function(A,E,D){if(!q){return}if(A>-1){m=A}if(n!=E){n=E;o.setFocusedIndex(-1);var x=(n==null)||(n=="");var w='<span class="'+cnMatchedString+'">';var B="</span>";var v=D?"":"i";var C=new RegExp(n,v);var z;var H;var F;var G;for(var y=q.length-1;y>=0;y--){H=q[y];F=H.cells[m];G=F.innerHTML.replace(w,"").replace(B,"");F.innerHTML=G;if(x==false){z=G.match(C);if(z){F.innerHTML=G.replace(z[0],w+z[0]+B);H.style.display=STableRow}else{H.style.display=SNone}}else{H.style.display=STableRow}}r.scrollTop=0}};this.insertRow=function(v){var w=r.insertRow(v);w.onclick=u;w.onmouseout=t;w.onmouseover=h;return w};this.deleteRow=function(v){o.setFocusedIndex(-1);r.deleteRow(v);if(f>v){o.setSelectedIndex(f-1)}else{if(f==v){o.setSelectedIndex(-1)}}};this.cells=function(w,v){return r.rows[w].cells[v]};this.autoClearTextBox=true;this.onChange=null;this.onFocusChange=null;this.onSelectChange=null};function $fx(c){if(c.nodeType&&c.nodeType==1){var e=c}else{if(String(c).match(/^#([^$]+)$/i)){var e=document.getElementById(RegExp.$1);if(!e){return null}}else{return null}}if(typeof(e.fx)!="undefined"&&e.fx){return e}e.fxVersion=0.1;e.fx={};e.fx.sets=[];e.fx.currentSetIndex=0;var a={"left|top|right|bottom|width|height|margin|padding|spacing|backgroundx|backgroundy":"px",font:"pt",opacity:""};var b={delay:100,step:5,unit:""};var d={opacity:function(g,f){if(g!=null){g=Math.min(100,Math.max(0,g));e.style.opacity=g*0.01}else{return Math.round(parseFloat(e.style.opacity)*100)}},backgroundx:function(i,g){var f=0,j=0;var h=(new RegExp("^(-?\\d+)[^\\d\\-]+(-?\\d+)")).exec(e.style.backgroundPosition);if(h){f=parseInt(h[1]);j=parseInt(h[2])}if(i!=null){e.style.backgroundPosition=i+g+" "+j+g}else{return f}},backgroundy:function(i,g){var f=0,j=0;var h=(new RegExp("^(-?\\d+)[^\\d\\-]+(-?\\d+)")).exec(e.style.backgroundPosition);if(h){f=parseInt(h[1]);j=parseInt(h[2])}if(i!=null){e.style.backgroundPosition=f+g+" "+i+g}else{return j}}};e.fxAddSet=function(){var f=this.fx.sets.length;this.fx.currentSetIndex=f;this.fx.sets[f]={loopCount:1,loopsDone:0,effects:[],effectsDone:0,holdTime:0,isRunning:false};return this};e.fxHold=function(g,f){if(!e.fx.sets[this.fx.currentSetIndex].isRunning){this.fx.sets[isNaN(f)?this.fx.currentSetIndex:f].holdTime=g}return this};e.fxAdd=function(h){var i=this.fx.sets[this.fx.currentSetIndex];if(i.isRunning){return this}for(var g in b){if(!h[g]){h[g]=b[g]}}if(!h.unit){for(var f in a){if((new RegExp(f,"i").test(h.type))){h.unit=a[f];break}}}if(!this.fx[h.type]){if(d[h.type]){this.fx[h.type]=d[h.type]}else{this.fx[h.type]=function(k,j){if(k!=null){e.style[h.type]=k+j}else{return parseInt(e.style[h.type])}}}}if(h.from==null){h.from=this.fx[h.type](null,null)}h.initial=h.from;i.effects.push(h);return this};e.fxRun=function(h,f,g){var i=e.fx.sets[e.fx.currentSetIndex];if(i.isRunning){return this}setTimeout(function(){if(i.isRunning){return e}i.isRunning=true;if(i.effectsDone>0){return e}if(!isNaN(f)){i.loopCount=f}for(var j=0,k;j<i.effects.length;j++){k=i.effects[j];if(k.onstart){k.onstart.call(e)}e.fx.animate(e.fx.currentSetIndex,j)}},i.holdTime);return this};e.fxStop=function(f){this.fx.sets[!isNaN(f)?f:this.fx.currentSetIndex].isRunning=false;return this};e.fxReset=function(){var k=this.fx.sets;for(var h=0;h<k.length;h++){for(var g=0;g<k[h].effects.length;g++){var m=k[h].effects[g];this.fx[m.type](m.initial,m.unit)}}var f=["fx","fxHold","fxAdd","fxAddSet","fxRun","fxPause","fxStop","fxReset"];for(var h=0;h<f.length;h++){try{delete this[f[h]]}catch(l){this[f[h]]=null}}};e.fx.animate=function(f,g){var p=this.sets[f];if(!p||!p.isRunning){return}var r=p.effects[g];var k=this[r.type](null,null);var j=Math.abs(r.step);var o=k+j;var m=k-j;if((o<r.to)||(m>r.to)){if(o<r.to){this[r.type](o,r.unit)}else{this[r.type](m,r.unit)}var q=this;setTimeout(function(){if(q.animate){q.animate(f,g)}},r.delay)}else{this[r.type](r.to,r.unit);p.effectsDone++;if(r.onfinish!=null){r.onfinish.call(e)}if(p.effects.length==p.effectsDone){p.effectsDone=0;p.loopsDone++;if(p.onloop!=null){p.onloop.call(e,p.loopsDone)}if(p.loopCount==-1||p.loopsDone<p.loopCount){for(var n=0;n<p.effects.length;n++){this[r.type](r.from,p.effects[n].unit);p.effects[n].onstart.call(e,p.loopsDone);this.animate(f,n)}}else{if(p.onfinal!=null){p.onfinal.call(e)}p.isRunning=false}}}};e.fxAddSet();return e};function TInfoBox(){var b=newElement("div","TInfoBox AbsPos");b.innerHTML='<div class="TInfoBoxContent"></div><img class="TPink" src="images/Pink.png" />';b.style.visibility=SHidden;b.setContent=function(c){var e=this.childNodes[0];var f=this.childNodes[1];e.innerHTML=c;f.style.left=(this.offsetWidth-f.offsetWidth)*0.5+SPixel;this.style.height=(e.offsetHeight+f.offsetHeight)+SPixel};b.setPosition=function(e,h,c,g,f){this.mX=e;this.mY=h;this.mOffsetX=c;this.mOffsetY=g;this.onScaleChange(f)};b.onScaleChange=function(c){this.style.left=(this.mX*c+this.mOffsetX-this.childNodes[1].offsetLeft)+SPixel;this.style.top=(this.mY*c+this.mOffsetY-this.offsetHeight)+SPixel};function a(c){c.stopPropagation()}var d=b.childNodes[0];d.onclick=d.ondblclick=d.onmousedown=d.onmousemove=d.onmouseup=d.onmousewheel=a;b.mX=0;b.mY=0;return b};var etDetector=0;var etTag=1;var EntityNames=["detector","tag"];var EntityClassNames=["TDetector","TTag"];function AJAX(e,b,d){function a(g){try{if(this.mMethod=="POST"){this.open(this.mMethod,this.mUrl,true);this.setRequestHeader("Content-type","application/x-www-form-urlencoded");this.send(g)}else{this.open(this.mMethod,this.mUrl+"?"+g,true);this.send()}}catch(f){console.log("AJAX failed")}}var c=new XMLHttpRequest();c.mMethod=e;c.mUrl=b;c.onreadystatechange=d;c.doSend=a;return c}var rsOK=0;var rsSessionEnd=1;var rsInvalidArgument=2;function processResponse(ajax,entityType){var response;var table=tagTable;var entities=tags;if(entityType==etDetector){table=detectorTable;entities=detectors}if(ajax.readyState==4&&ajax.status==200){response=eval(ajax.responseText);if(!response){return}if(response.request=="login"){loginButton.disabled=false;if(response.status==rsOK){updateUI(true);showMessage(mtInfo,null,true)}else{showMessage(mtError,response.data,true)}return}if(response.status!=rsOK){deleteRowIndex=-1;if(response.status==rsSessionEnd){updateUI(false)}showMessage(mtError,response.data,true);return}if(response.request.indexOf("get")>-1){doGet()}else{if(response.request.indexOf("add")>-1){doAdd()}else{doDelete()}}}function doDelete(){table.deleteRow(deleteRowIndex);map.removeEntity(entities.splice(deleteRowIndex,1)[0]);deleteRowIndex=-1}function doAdd(){var entity=null,row;var info=response.data;info.b=BatteryStatus[info.b];for(var i=0;i<entities.length;i++){if(entities[i].mId==info.i){entity=entities[i];break}}if(entity){row=entity.mLinkedRow;if(entityType==etTag){row.cells[1].innerHTML=info.a;row.cells[2].innerHTML=info.x.toFixed(1);row.cells[3].innerHTML=info.y.toFixed(1)}else{row.cells[1].innerHTML=info.x.toFixed(1);row.cells[2].innerHTML=info.y.toFixed(1)}entity.setPosition(info.x,info.y,map.getScale())}else{row=table.insertRow(-1);entity=TMapEntity(entityType);var columnNames=["Id","X","Y","Battery","More"];var cellValues=[info.i,info.x.toFixed(1),info.y.toFixed(1),info.b,""];if(entityType==etTag){columnNames.splice(1,0,"AssetId");cellValues.splice(1,0,info.a)}var j,cell;for(j=0;j<cellValues.length;j++){cell=row.insertCell(-1);cell.innerHTML=cellValues[j];cell.className="Col "+columnNames[j]}cell.appendChild(createDeleteButton(entityType,row,table));row.mLinkedEntity=entity;entity.set(info,row,table);entities.push(entity);map.addEntity(entity)}map.selectEntity(null);map.selectEntity(entity)}function doGet(){var columnNames=["Id","X","Y","Battery","More"];if(entityType==etTag){columnNames.splice(1,0,"AssetId")}var newEntityCount=response.data.length-1;var curEntityCount=entities.length;if(newEntityCount<curEntityCount){for(var i=curEntityCount-1;i>=newEntityCount;i--){map.removeEntity(entities[i]);detectorTable.deleteRow(-1);entities[i]=null}}entities.length=newEntityCount;var row,entity,info,cellValues,cell;for(var i=0;i<newEntityCount;i++){info=response.data[i];info.b=BatteryStatus[info.b];cellValues=[info.i,info.x.toFixed(1),info.y.toFixed(1),info.b,"&nbsp;"];if(entityType==etTag){cellValues.splice(1,0,info.a)}if(!entities[i]){entity=TMapEntity(entityType);entities[i]=entity;map.addEntity(entity);row=table.insertRow(-1);for(var j=0;j<cellValues.length;j++){cell=row.insertCell(-1);cell.innerHTML=cellValues[j];cell.className="Col "+columnNames[j]}if(isLoggedIn){cell.innerHTML="";cell.appendChild(createDeleteButton(entityType,row,table))}}else{entity=entities[i];row=table.getElement().rows[i];for(var j=0;j<cellValues.length-1;j++){cell=row.cells[j];cell.innerHTML=cellValues[j]}}row.mLinkedEntity=entity;entity.set(info,row,table);map.invalidate()}}}var headerPanel,tabControl,tabPanel;var welcomeTab,assetsTab,detectorsTab;var map,mapImage,mapToolbar;var tags=[],detectors=[];var tagTable,detectorTable;var activeTable;var tagUpdateTimer;var loginDialog;var usernameTextBox;var passwordTextBox;var loginButton;var msgLabel;var loggedInDialog;var isLoggedIn=false;var buttonAnimationParams={type:"left",unit:"px",to:0,step:24,delay:20};var panelAnimationParams={type:"left",unit:"px",to:0,step:25,delay:20};var msgLabelAnimationParams={type:"opacity",to:100,step:10,delay:25,fadeOut:true,fadeOutTimeOut:4000,onfinish:function(){var a=msgLabelAnimationParams;if(a.to==0){a.to=100}else{if(a.fadeOut){a.to=0;a.timerHandle=setTimeout(this.fxRun,a.fadeOutTimeOut)}}}};var mtInfo=0,mtError=1;var StatusColors=["#04F","#F40"];function showMessage(a,c,b){clearTimeout(msgLabelAnimationParams.timerHandle);if(c!=null){if(msgLabelAnimationParams.to==0){msgLabelAnimationParams.to=100}msgLabelAnimationParams.fadeOut=b;msgLabel.style.color=StatusColors[a];msgLabel.innerHTML=c}else{msgLabelAnimationParams.to=0;msgLabelAnimationParams.fadeOut=false}msgLabel.fxRun()}var BatteryStatus=["Normal","Low!"];var deleteRowIndex=-1;var loginRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,-1)});var tagRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,etTag)});var detectorRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,etDetector)});function login(){if(usernameTextBox.value==""){showMessage(mtError,"Please enter the username.",true);return}if(passwordTextBox.value==""){showMessage(mtError,"Please enter the password.",true);return}showMessage(mtInfo,"Logging in...",false);loginButton.disabled=true;loginRequestManager.doSend("request=login&username="+usernameTextBox.value+"&password="+passwordTextBox.value);usernameTextBox.value="";passwordTextBox.value=""}function logout(){loginRequestManager.doSend("request=logout");updateUI(false)}function createDeleteButton(e,f,d){function c(i){if(deleteRowIndex==-1){deleteRowIndex=this.mLinkedRow.rowIndex;var g=this.mEntityType;var b=EntityNames[g];if(confirm("Delete this "+b+" permanently?")){var h=this.mEntityType==etTag?tagRequestManager:detectorRequestManager;h.doSend("request=del-"+b+"&"+b+"-id="+this.mLinkedRow.mLinkedEntity.mId)}}else{showMessage(mtError,"Please wait for the current request to finish.",true)}i.stopPropagation()}var a=newElement(SDiv,"DeleteButton");a.mEntityType=e;a.mLinkedTable=d;a.mLinkedRow=f;a.onclick=c;a.title="Delete";return a}function updateUI(a){if(isLoggedIn==a){return}var h=$("mapUploadFrame");h.style.display=a?SBlock:SNone;if(h.contentWindow){h.contentWindow.location.reload()}else{frames.mapUploadFrame.location.reload()}var f,e=[tagTable.getElement(),detectorTable.getElement()];if(a){$("greetingLabel").innerHTML='Hi <strong style="color: blue;">'+getCookie("username")+"</strong>";loggedInDialog.style.display=SBlock;loginDialog.style.display=SNone;for(var c=0;c<e.length;c++){f=e[c];for(var b=0,g;b<f.rows.length;b++){g=f.rows[b];g.lastChild.innerHTML="";g.lastChild.appendChild(createDeleteButton(c,g,f))}}h=document.createElement(SDiv);h.id="addModifyTagDialog";h.setAttribute("style","float: left; width: 315px; background-color: #EEF; margin-top: 3px;");h.innerHTML='<div style="float: left;"><input type="textbox" id="tTextBox" class="Col Id Cell" placeholder="ID" /><input type="textbox" id="aTextBox" class="Col AssetId Cell" placeholder="Asset ID" /></div><button id="addTagButton" style="margin-left: 0.5em; width: 50px;">Add</button>';assetsTab.appendChild(h);$("addTagButton").onclick=function(){var i=$("tTextBox"),d=$("aTextBox");if(i.value==""){showMessage(mtError,"Please enter tag ID",true)}else{if(d.value==""){showMessage(mtError,"Please enter asset ID",true)}else{tagRequestManager.doSend("request=add-tag&tag-id="+i.value+"&asset-id="+d.value);i.value=d.value=""}}};h=document.createElement(SDiv);h.id="addModifyDetectorDialog";h.title="Click on the map to place the detector";h.setAttribute("style","float: left; width: 189px; background-color: #EEF; margin-top: 3px;");h.innerHTML='<div style="float: left;"><input type="textbox" id="dTextBox" class="Col Id Cell" placeholder="ID" /><input type="textbox" id="xTextBox" class="Col X Cell" placeholder="X" /><input type="textbox" id="yTextBox" class="Col Y Cell" placeholder="Y" /></div><button id="addDetectorButton" style="margin-left: 0.5em; width: 50px;">Add</button>';detectorsTab.appendChild(h);$("addDetectorButton").onclick=function(){var j=$("dTextBox"),i=$("xTextBox"),k=$("yTextBox");if(j.value==""){showMessage(mtError,"Please enter detector ID",true)}else{if(i.value==""||k.value==""){showMessage(mtError,"Please enter detector's location",true)}else{detectorRequestManager.doSend("request=add-detector&detector-id="+j.value+"&x="+i.value+"&y="+k.value);j.value=i.value=k.value=""}}};map.onClick=function(d,i){$("xTextBox").value=d.toFixed(1);$("yTextBox").value=i.toFixed(1)}}else{loginDialog.style.display=SBlock;loggedInDialog.style.display=SNone;for(var c=0;c<e.length;c++){f=e[c];for(var b=0;b<f.rows.length;b++){f.rows[b].lastChild.innerHTML="&nbsp;"}}h=$("addModifyTagDialog");if(h){assetsTab.removeChild(h)}h=$("addModifyDetectorDialog");if(h){detectorsTab.removeChild(h)}map.onClick=null}isLoggedIn=a}function TMapEntity(e){function g(j,i,h){this.mId=j.i;this.mX=j.x;this.mY=j.y;this.mBattery=j.b;this.mLinkedRow=i;this.mLinkedTable=h;if(j.a){this.mTimestamp=j.s;this.mAssetId=j.a}}function c(h,j,i){this.mX=h;this.mY=j;this.onScaleChange(i)}function a(h){this.style.left=(this.mX*h-this.firstChild.offsetWidth*0.5)+SPixel;this.style.top=(this.mY*h-this.offsetHeight)+SPixel}function f(){return'<table cellspacing="0" style="border-collapse: collapse; width: 100%;"><caption style="color: Red; font-weight: bold;">Tag</caption><tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mId+'</td></tr><tr style="border: none;"><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mAssetId+'</td></tr><tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mBattery+"</td></tr></table>"}function d(){return'<table cellspacing="0" style="border-collapse: collapse; width: 100%;"><caption style="color: Red; font-weight: bold;">Detector</caption><tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mId+'</td></tr><tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mBattery+"</td></tr></table>"}var b=newElement(SDiv,"TMapEntity");b.style.zIndex=e;b.appendChild(newElement(SDiv,EntityClassNames[e]));b.set=g;b.setPosition=c;b.onScaleChange=a;if(e==etTag){b.getInfo=f}else{b.getInfo=d}return b}function requestTagsInfo(){tagRequestManager.doSend("request=get-tags")}function adjusMapRect(){map.setRect(tabPanel.offsetLeft+tabPanel.offsetWidth,headerPanel.offsetHeight,window.innerWidth,window.innerHeight)}function getCookie(f){var c,b,a,e,d=document.cookie.split(";");for(c=0;c<d.length;c++){b=d[c].indexOf("=");a=d[c].substr(0,b);e=d[c].substr(b+1);a=a.replace(/^\s+|\s+$/g,"");if(a==f){return unescape(e)}}return null}onresize=function(){adjusMapRect();mapToolbar.style.left=(window.innerWidth-mapToolbar.offsetWidth-10)+SPixel;mapToolbar.style.top=(window.innerHeight-mapToolbar.offsetHeight-10)+SPixel;tabPanel.style.height=(window.innerHeight-headerPanel.offsetHeight)+SPixel};onload=function(){headerPanel=$("headerPanel");tabPanel=$("tabPanel");$fx(tabPanel).fxAdd(panelAnimationParams);tabControl=new TTabControl(tabPanel);welcomeTab=$("welcomeTab");assetsTab=$("assetsTab");detectorsTab=$("detectorsTab");loginDialog=$("loginDialog");usernameTextBox=$("usernameTextBox");passwordTextBox=$("passwordTextBox");loginButton=$("loginButton");loggedInDialog=$("loggedInDialog");msgLabel=$("msgLabel");$fx(msgLabel).fxAdd(msgLabelAnimationParams);var c=null;if(browser.isIE){c="Internet Explorer"}else{if(browser.isFirefox){c="Mozilla Firefox"}}if(c!=null){showMessage(mtInfo,"You are using <strong>"+c+'</strong>.<br />For the best experience, please use <a href="http://www.google.com/chrome/intl/en/make/download.html?brand=CHKZ" target="_blank" style="font-weight: bold;">Google Chrome</a>',true)}function a(){var f=this.getSelectedRow();if(this==activeTable||f!=null){var e=f?f.mLinkedEntity:null;map.selectEntity(e)}}tagTable=new TFlexTable($("assetsTab"));tagTable.attachTextBox($("assetSearchBox"),1);tagTable.onSelectChange=a;detectorTable=new TFlexTable($("detectorsTab"));detectorTable.attachTextBox($("detectorSearchBox"),0);detectorTable.onSelectChange=a;activeTable=tagTable;mapToolbar=$("mapToolbar");map=new TMap();map.onLoad=function(){mapToolbar.style.visibility=SVisible};map.onSelectChange=function(){var f=-1;var g=this.getSelectedEntity();if(g){var i=g.mLinkedTable;if(activeTable!=i){var h=activeTable;activeTable=i;h.setSelectedIndex(-1)}f=g.mLinkedRow.rowIndex}activeTable.setSelectedIndex(f)};mapImage=new Image();mapImage.src="images/FloorPlan.jpg?"+(new Date()).getTime();mapImage.onload=function(){map.setMapImage(this,120)};tagUpdateTimer=new TTimer(2000,requestTagsInfo);tagUpdateTimer.setEnabled(true);requestTagsInfo();detectorRequestManager.doSend("request=get-detectors");var b=$("showHideTabPanelButton");b.style.left=(tabPanel.offsetWidth-b.offsetWidth-3)+SPixel;b.style.top=(tabPanel.offsetTop+3)+SPixel;b.onclick=function(){if(this.offsetLeft>0){this.innerHTML="»";this.className="TextIcon TCastShadow";this.title="Show panel";panelAnimationParams.to=-tabPanel.offsetWidth;panelAnimationParams.onfinish=null;buttonAnimationParams.to=0;map.setRect(0,headerPanel.offsetHeight,window.innerWidth,window.innerHeight)}else{this.innerHTML="«";this.className="TextIcon";this.title="Hide panel";panelAnimationParams.to=0;panelAnimationParams.onfinish=adjusMapRect;buttonAnimationParams.to=tabPanel.offsetWidth-this.offsetWidth-3}this.fxRun();tabPanel.fxRun()};$fx(b).fxAdd(buttonAnimationParams);function d(h,l,k){var j=map.getSelectedEntity();if(j&&j.firstChild.className==h){map.selectEntity(null)}var f=k?SVisible:SHidden;var g=h=="TTag"?1:2;tabControl.setTabVisible(g,k);for(var g=0;g<l.length;g++){l[g].style.visibility=f}}$("showAssetsCheckBox").onchange=function(){d("TTag",tags,this.checked)};$("showDetectorsCheckBox").onchange=function(){d("TDetector",detectors,this.checked)};onresize();if(getCookie("username")){updateUI(true)}};function changeMapImage(){var b=$("mapUploadFrame").contentWindow.document.getElementsByTagName("label")[0].innerHTML;if(b!=""){var a=JSON.parse(b);if(a){if(a.status==0){mapImage=new Image();mapImage.src="images/FloorPlan.jpg?"+(new Date()).getTime();mapImage.onload=function(){map.setMapImage(this,120)}}else{showMessage(mtError,a.data,true)}}}};function TMap(){var C=0.002;var m=5;var o=8;var b=40;var A=b*0.005;var x=b*0.006;var F=1.05;var u="url(images/closedhand_8_8.cur), move";if(browser.isFirefox){o=2;A=b*0.004;F=1.06}else{if(browser.isChrome){u="move"}}var d=this;var l=csLoading;var k=null;var t=new TVector2D();var v=0;var h=new TVector2D();var I=0;var a=0;var H=A;var P={position:new TVector2D(),velocity:new TVector2D(),isLeftButtonDown:false};var s={position:new TVector2D(),targetPosition:new TVector2D(),scale:1,targetScale:1,totalScale:1};var N=new TTimer(b,function(){j();H*=F});var w=[];var M=null;var c=document.createElement(SDiv);c.setAttribute("style","position: absolute; z-index: 0; overflow: hidden; background-color: rgba(255, 255, 255, 0);");document.body.appendChild(c);var z=document.createElement(SDiv);z.style.position="absolute";c.appendChild(z);var O={type:"opacity",unit:"",to:100,step:10,delay:25,onfinish:function(){if(parseFloat(this.style.opacity)==0){this.style.visibility=SHidden}}};var J=TInfoBox();J.style.zIndex=101;J.style.opacity=0;J.style.color="#0860B6";z.appendChild(J);$fx(J).fxAdd(O);var e=TInfoBox();e.style.zIndex=100;z.appendChild(e);h.x=c.offsetWidth*0.5;h.y=c.offsetHeight*0.5;mapMouseDown=function(Q){if(Q.button==0){N.setEnabled(false);P.isLeftButtonDown=true;r(Q,false);Q.preventDefault()}};mapMouseMove=function(Q){r(Q,true);if(P.isLeftButtonDown){this.style.cursor=u;s.targetPosition.add(P.velocity);s.position.assign(s.targetPosition);L();Q.preventDefault()}};mapMouseUp=function(S){if(S.button==0){this.style.cursor="default";P.isLeftButtonDown=false;r(S,false);if(!P.velocity.equals(ZeroVector2D,m)){s.targetPosition.multAddSet(s.position,P.velocity,o);H=A;N.setEnabled(true)}else{d.selectEntity(null);if(d.onClick){var R=1/s.totalScale;var Q=(P.position.x-s.position.x)*R;var T=(P.position.y-s.position.y)*R;d.onClick(Q,T)}}}};mapMouseWheel=function(R){var S=R.detail?-R.detail:R.wheelDelta;var Q=0.5;if(S>0){Q=2}d.zoom(R,Q);R.preventDefault()};mapDoubleClick=function(Q){d.zoom(Q,2);Q.preventDefault()};function p(Q){var R=Q.touches[0];Q.pageX=R.pageX;Q.pageY=R.pageY;Q.button=0}function y(Q){p(Q);mapMouseDown(Q)}function i(Q){p(Q);mapMouseUp(Q)}function K(Q){p(Q);mapMouseMove(Q)}function E(){if(this!=M){J.setContent(this.getInfo());J.setPosition(this.mX,this.mY,0,-this.offsetHeight,s.totalScale);J.style.visibility=SVisible;O.to=100;J.fxRun()}}function G(){O.to=0;J.fxRun()}function D(Q){d.selectEntity(this);Q.stopPropagation()}function g(){if(k){var Q=c.offsetWidth/t.x;var R=c.offsetHeight/t.y;I=Math.min(Q,R)*0.45}else{I=1}a=4*I}function B(){s.scale=0.001;s.targetScale=I;s.totalScale=s.scale*v;s.position.multSubSet(h,t,s.scale);s.targetPosition.multSubSet(h,t,s.targetScale);H=A;N.setEnabled(true)}function n(R){var Q=new TVector2D();Q.multAddSet(s.position,R,s.totalScale);return Q}function r(S,R){if(S){var Q=S.pageX-c.offsetLeft;var T=S.pageY-c.offsetTop;if(R){P.velocity.x=Q-P.position.x;P.velocity.y=T-P.position.y}P.position.x=Q;P.position.y=T}else{P.position.assign(h)}}function j(){var Q=true;if(!s.position.equals(s.targetPosition,1)){Q=false;s.position.lerp(s.position,s.targetPosition,H);L()}var S=s.targetScale-s.scale;if(!isZero(S,C)){Q=false;s.scale+=S*H;s.totalScale=s.scale*v;q();J.onScaleChange(s.totalScale);e.onScaleChange(s.totalScale);for(var R=0;R<w.length;R++){w[R].onScaleChange(s.totalScale)}}if(Q){N.setEnabled(false);if(l==csLoading){l=csLoaded;c.ondblclick=mapDoubleClick;c.onmousedown=mapMouseDown;c.onmousemove=mapMouseMove;c.onmouseup=mapMouseUp;c.onmousewheel=mapMouseWheel;c.addEventListener("DOMMouseScroll",mapMouseWheel,false);if(typeof TouchEvent!=SUndefined){c.ontouchstart=y;c.ontouchmove=K;c.ontouchend=i}if(d.onLoad){d.onLoad()}}}}this.setMapImage=function(R,Q){if((k!=R)&&R){if(k){z.removeChild(k)}v=Q;t.x=R.width*0.5;t.y=R.height*0.5;R.style.position="absolute";R.style.boxShadow="rgba(0,0,0,0.3) 0 0 4px 4px";z.insertBefore(R,z.firstChild);k=R;g();B()}};this.setGrid=function(Q,R){};function L(){z.style.left=s.position.x+SPixel;z.style.top=s.position.y+SPixel}function q(){k.style.width=2*t.x*s.scale+SPixel;k.style.height=2*t.y*s.scale+SPixel}this.invalidate=function(){L();if(k){q()}for(var Q=0;Q<w.length;Q++){w[Q].onScaleChange(s.totalScale)}};this.zoom=function(R,Q){if(Q<0){return}r(R,false);if(Q>0){s.targetScale=ensureRange(s.scale*Q,I,a);s.targetPosition.lerp(P.position,s.position,s.targetScale/s.scale)}else{s.targetScale=I;s.targetPosition.multSubSet(P.position,t,s.targetScale)}if(!(s.position.equals(s.targetPosition,m)&&isZero(s.scale-s.targetScale,C))){H=x;N.setEnabled(true)}};this.setRect=function(S,T,V,Q){var R=V-S;var U=Q-T;h.x=R*0.5;h.y=U*0.5;s.position.x-=S-c.offsetLeft;s.position.y-=T-c.offsetTop;s.targetPosition.assign(s.position);c.style.left=S+SPixel;c.style.top=T+SPixel;c.style.width=R+SPixel;c.style.height=U+SPixel;g();if(l==csLoaded){L()}};this.bringToCenter=function(Q){if(Q&&(Q.parentNode==z)){s.targetPosition.x=h.x-Q.mX*s.totalScale;s.targetPosition.y=h.y-Q.mY*s.totalScale;H=A;N.setEnabled(true)}};this.addEntity=function(Q){if(Q&&(Q.parentNode!=z)){Q.addEventListener(SClick,D,false);Q.addEventListener(SMouseOut,G,false);Q.addEventListener(SMouseOver,E,false);w.push(Q);z.appendChild(Q);Q.onScaleChange(s.totalScale)}};this.selectEntity=function(U){if(U!=M){if(U){J.style.visibility=SHidden;e.setContent(U.getInfo());e.setPosition(U.mX,U.mY,0,-U.offsetHeight,s.totalScale);e.style.visibility=SVisible;var R=U.offsetLeft,Y=U.offsetTop,aa=U.offsetWidth+R,V=U.offsetHeight+Y,S=e.offsetLeft,Z=e.offsetTop,ac=e.offsetWidth+S,W=e.offsetHeight+Z,T=Math.min(R,S)+z.offsetLeft,ab=Math.min(Y,Z)+z.offsetTop,Q=Math.max(aa,ac)+z.offsetLeft,X=Math.max(V,W)+z.offsetTop;if((T<0)||(ab<0)||(Q>c.offsetWidth)||(X>c.offsetHeight)){d.bringToCenter(U)}}else{e.style.visibility=SHidden}M=U;if(d.onSelectChange){d.onSelectChange()}}};function f(Q){Q.removeEventListener(SClick,D,false);Q.removeEventListener(SMouseOut,G,false);Q.removeEventListener(SMouseOver,E,false);z.removeChild(Q)}this.deleteEntity=function(Q){checkRange(Q,0,w.length-1);f(w.splice(Q,1)[0])};this.removeEntity=function(Q){this.deleteEntity(w.indexOf(Q))};this.removeAll=function(){for(var R=0,Q;R<w.length;R++){f(Q)}w.length=0};this.getEntity=function(Q){checkRange(Q,0,w.length-1);return w[Q]};this.getEntityCount=function(){return w.length};this.getSelectedEntity=function(){return M};this.getScale=function(){return s.totalScale};this.onLoad=null;this.onSelectChange=null;this.onClick=null};var cnTabPanel="TTabPanel";var cnTabName="TTabName";var cnTabNameSelected="TTabName Selected";var cnTabNamePanel="TTabNamePanel";var cnTabContent="TTabContent";var cnTabContentPanel="TTabContentPanel";function TTabControl(b){if(!b){return}var h=this;var a=b.getElementsByTagName("*");var d=c(a,cnTabName);if(d.length==0){return}var j=c(a,cnTabContent);if((j.length==0)||(j.length!=d.length)){return}var e=0;for(var f=0;f<d.length;f++){d[f].__idx=f;d[f].className=cnTabName;d[f].onclick=g;j[f].style.display=SNone}d[0].className=cnTabNameSelected;j[0].style.display=SBlock;function c(o,m){var k=[];var n=new RegExp("\\b"+m+"\\b");if(o){for(var l=0;l<o.length;l++){if(o[l].className.search(n)>-1){k.push(o[l])}}}return k}function g(i){h.selectTab(this.__idx);i.preventDefault()}this.selectTab=function(i){checkRange(i,0,d.length-1);if(e!=i){d[e].className=cnTabName;j[e].style.display=SNone;d[i].className=cnTabNameSelected;d[i].style.display=SInline;j[i].style.display=SBlock;e=i}};this.setTabVisible=function(i,k){checkRange(i,0,d.length-1);if((e!=i)&&(d.length>1)){d[i].style.display=k?SInline:SNone}};this.getSelectedIndex=function(){return e}};function TTabPanel(){var h="TTabName";var f=this;var b=0;var e=-1;var g=newElement("div","TTabPanel");var d=newElement("ul","TTabNamePanel");var c=newElement("div","TTabContentPanel");g.appendChild(d);g.appendChild(c);function a(i){console.log(this.__idx);f.selectTab(this.__idx);i.preventDefault()}this.getElement=function(){return g};this.add=function(j,k){var l=newElement("li",h);if(j instanceof HTMLElement){l.appendChild(j)}else{l.innerHTML=j}l.__idx=b;l.onclick=a;console.log(l.onclick);d.appendChild(l);if(k instanceof HTMLElement){c.appendChild(k)}else{var i=newElement("div","TTabContent");i.style.display=SNone;i.innerHTML=k;c.appendChild(i)}b++;console.log("Tab Count = "+b);return b-1};this.remove=function(i){if(isInRange(i,0,b-1)){d.removedChild(d.childNodes[i]);c.removedChild(c.childNodes[i]);b--}else{throw SIndexOutOfRange+i}};this.selectTab=function(i){if(isInRange(i,0,b-1)){if(e!=i){if(e>-1){d.childNodes[e].className=h;c.childNodes[e].style.display=SNone}d.childNodes[i].className="TSelectedTabName";c.childNodes[i].style.display=SBlock;e=i;if(f.onChanged){f.onChanged()}}}else{throw SIndexOutOfRange+i}};this.getSelectedIndex=function(){return e};this.getTabCount=function(){return b};this.onChanged=null};function TTimer(a,d){var e;var c=false;var b=d;var f=a;this.setInterval=function(g){if(f!=g){f=g;if(c){clearInterval(e);e=setInterval(b,f)}}};this.setEnabled=function(g){if(c!=g){if(g){e=setInterval(b,f)}else{clearInterval(e)}c=g}}};var SUndefined="undefined";var SIndexOutOfRange="Index out of range: ";var SPixel="px";var SNone="none";var SBlock="block";var SHidden="hidden";var SVisible="visible";var SFocus="focus";var SBlur="blur";var SKeyDown="keydown";var SKeyUp="keyup";var SClick="click";var SMouseDown="mousedown";var SMouseMove="mousemove";var SMouseUp="mouseup";var SMouseWheel="mousewheel";function newElement(b,c){var a=document.createElement(b);if(a){a.className=c;return a}return null}function $(a){return document.getElementById(a)}function isZero(a,b){return Math.abs(a)<b}function isInRange(b,c,a){return(b>=c&&b<=a)}function ensureRange(b,c,a){if(b<c){return c}if(b>a){return a}return b}function parsePixelString(a){return parseInt(a.replace("px",""))};function TVector2D(){this.x=0;this.y=0}TVector2D.prototype={assign:function(a){this.x=a.x;this.y=a.y},multAddSet:function(c,b,a){this.x=c.x+b.x*a;this.y=c.y+b.y*a},multSubSet:function(c,b,a){this.x=c.x-b.x*a;this.y=c.y-b.y*a},equals:function(a,b){return isZero(this.x-a.x,b)&&isZero(this.y-a.y,b)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},squaredLength:function(){return this.x*this.x+this.y*this.y},distanceTo:function(a){var c=this.x-a.x;var b=this.y-a.y;return Math.sqrt(c*c+b*b)},lerp:function(c,b,a){this.x=c.x+a*(b.x-c.x);this.y=c.y+a*(b.y-c.y)},add:function(a){this.x+=a.x;this.y+=a.y},sub:function(a){this.x-=a.x;this.y-=a.y},mult:function(a){this.x*=a;this.y*=a},dotProduct:function(a){return this.x*a.x+this.y*a.y},toString:function(){return"(X: "+this.x.toFixed(1)+", Y: "+this.y.toFixed(1)+")"}};ZeroVector2D=new TVector2D();