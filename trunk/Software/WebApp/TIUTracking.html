<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Asset Tracking System</title>
	<link rel="shortcut icon" href= "favicon.ico">
	<script type="application/x-javascript">
		var headerPanel;
		var tabControl;
		var elTabPanel;
		
		var map;
		var elMapImage;
		var elMapToolbar;
		
		var assetTags = [];
		var assetTable;
		var elAssetTable;
		
		var detectors = [];
		var detectorTable;
		var elDetectorTable;
		
		var ajax;
		var updateTimer;
		
		function update() {
			//ajax.open('GET', 'AssetInfo.php?id=', true);
			//ajax.send();
			var count = 10;
			
			// Table header
			cssClasses = ['TagId', 'AssetId', 'Timestamp', 'X', 'Y', 'Battery'];
			
			// Fake asset.
			for (var i = 0, asset; i < count; i++) {
				asset = new TAssetTag();
				asset.tagId = i;
				asset.assetId = randomId();
				asset.timestamp = '2011-04-21 20:21:22';
				asset.x = Math.round(23 * Math.random());
				asset.y = Math.round(9 * Math.random());
				asset.battery = SNormal;
				
				assetTags.push(asset);
				map.addEntity(asset);
				
				var row = assetTable.insertRow(-1);

				/*var html = '';
				for (var i in data) {
					html += '<td>' + data[i] + '</td>';
				}
				row.innerHTML = html;*/
				var data = asset.toArray();
				for (var j = 0; j < data.length; j++) {
					var cell = row.insertCell(-1);
					cell.innerHTML = data[j];
					cell.className = 'Col ' + cssClasses[j];
				}
			}
			//assetTable.setMaxRowCount(10);
		}
		
		function randomId() {
			var result = '';
			var hexDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
			for (var i = 0; i < 2; i++) {
				for (var j = 0; j < 4 + i; j++) {
					result += hexDigits[Math.floor(Math.random() * 15)];
				}
				result += '-';
			}
			for (var j = 0; j < 6; j++) {
				result += hexDigits[Math.floor(Math.random() * 15)];
			}
			return result;
		}
		
		onresize = function () {
			map.setRect(elTabPanel.offsetLeft + elTabPanel.offsetWidth, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
			elMapToolbar.style.left = (window.innerWidth - elMapToolbar.offsetWidth - 10) + SPixel;
			elMapToolbar.style.top  = (window.innerHeight - elMapToolbar.offsetHeight - 10) + SPixel;
			elTabPanel.style.height = (window.innerHeight - headerPanel.offsetHeight) + SPixel;
		}
		
		onload = function () {
			headerPanel = $('headerPanel');
			
			elTabPanel = $('elTabPanel');
			tabControl = new TTabControl(elTabPanel);

			assetTable = new TFlexTable($('assetsTab'));
			assetTable.attachTextBox($('assetSearchBox'), 1);
			
			elDetectorTable = $('elDetectorTable');
			elMapToolbar = $('elMapToolbar');
			
			elMapImage = new Image();
			elMapImage.src = 'images/FloorPlan.jpg';
			elMapImage.id = 'elMapImage';
			elMapImage.onload = function () {
				map.setMapImage(this, 120);
				//map.setSize(window.innerWidth, window.innerHeight);
			}
			
			map = new TMap();
			map.onLoad = function () {
				elMapToolbar.style.visibility = SVisible;
			}
			
			ajax = new XMLHttpRequest();
			ajax.onreadystatechanged = function () {
				if (this.readyState == 4 && this.status == 200) {
					var data = eval(this.responseText);
					assetTags.length = asset.length;
					for (var i = 0; i < asset.length; i++) {
						if (assetTags[i])
							assetTags[i].assign(data[i]);
						else
							assetTags[i] = new TAssetTag(data[i]);
					}
				}
			}
			
			//updateTimer = new TTimer(5000, update});
			//updateTimer.setEnabled(true);
			
			update();
			
			/*------------------------------------*/
			
			var button = $('showHideTabPanelButton');
			button.style.left = (elTabPanel.offsetWidth - button.offsetWidth - 3) + SPixel;
			button.style.top  = (elTabPanel.offsetTop + 3) + SPixel;
			button.onclick = function () {
				if (this.offsetLeft > 0) {
					this.style.left = 0;
					this.innerHTML = '>>';
					this.className = 'TCastShadow';
					this.title = 'Show panel';
					elTabPanel.style.left = -elTabPanel.offsetWidth + SPixel;
				} else {
					elTabPanel.style.left = 0;
					this.innerHTML = '<<';
					this.className = '';
					this.title = 'Hide panel';
					this.style.left = (elTabPanel.offsetWidth - this.offsetWidth - 3) + SPixel;
				}
				map.setRect(elTabPanel.offsetLeft + elTabPanel.offsetWidth, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
			}
			
			$('showAssetsCheckBox').onchange = function () {
				var v = this.checked ? SVisible : SHidden;
				tabControl.setTabVisible(1, this.checked);
				for (var i = 0; i < assetTags.length; i++)
					assetTags[i].element.style.visibility = v;
			}
			
			$('showDetectorsCheckBox').onchange = function () {
				tabControl.setTabVisible(2, this.checked);
			}
			
			$('showGridCheckBox').onchange = function () {
				$('gridSpacingTextBox').disabled = !this.checked;
			}
			
			onresize();
		}
	</script>
	<link href="TIUTracking.css" rel="stylesheet" type="text/css"/>
	<script type="application/x-javascript" src="js/AssetTag.js"></script>
	<script type="application/x-javascript" src="js/CellList.js"></script>
	<script type="application/x-javascript" src="js/Common.js"></script>
	<script type="application/x-javascript" src="js/FlexTable.js"></script>
	<script type="application/x-javascript" src="js/InfoBox.js"></script>
	<script type="application/x-javascript" src="js/Map.js"></script>
	<script type="application/x-javascript" src="js/TabControl.js"></script>
	<script type="application/x-javascript" src="js/Timer.js"></script>
	<script type="application/x-javascript" src="js/Vector2D.js"></script>
</head>
<body>
	<div id="headerPanel" class="TCastShadow" style="text-align: center;">
		Asset Tracking System
	</div>
	<button id="showHideTabPanelButton" title="Hide panel" style="position: absolute; z-index: 4; padding: 0; width: 20px; height: 20px; font-size: 10px; border-radius: 3px;">&lt;&lt;</button>
	<div id="elTabPanel" class="TTabPanel TCastShadow">		
		<ul class="TTabNamePanel">
			<li class="TTabName">&nbsp;Options&nbsp;</li>
			<li class="TTabName">&nbsp;&nbsp;Assets&nbsp;&nbsp;&nbsp;</li>
			<li class="TTabName">Detectors</li>
		</ul>
		<div class="TTabContentPanel">
			<div id="optionsTab" class="TTabContent" style="vertical-align: middle;">
				<input id="showAssetsCheckBox" type="checkbox" checked /><label for="showAssetsCheckBox">Show assets</label><br />
				<input id="showDetectorsCheckBox" type="checkbox" checked /><label for="showDetectorsCheckBox">Show detectors</label><br />
				<input id="showGridCheckBox" type="checkbox" /><label for="showGridCheckBox">Show grid</label><div style="float: right;"><label>Grid spacing</label><input id="gridSpacingTextBox" type="textbox" value="1" disabled style="margin-left: 10px; width: 40px;" /></div><br />
			</div>
			<div id="assetsTab" class="TTabContent">
				<input type="textbox" id="assetSearchBox" class="TSearchBox" placeholder="Search for an asset"/>
				<div class="TableHeader"><div class="Col TagId">Tag ID</div><div class="Col AssetId">Asset ID</div><div class="Col Timestamp">Timestamp</div><div class="Col X">X</div><div class="Col Y">Y</div><div class="Col Battery">Battery</div></div>
			</div>
			<div id="detectorsTab" class="TTabContent">
				<input type="textbox" id="detectorSearchBox" class="TSearchBox" placeholder="Search for a detector"/>
				<table id="elDetectorTable"></table>
			</div>
		</div>
	</div>
	<div id="elMapToolbar" class="TCastShadow">
		<button id="zoomOutButton" class="LeftPill TextIcon Translucent" onclick="map.zoom(null, 0.5);">-</button>
		<button id="zoomFitButton" class="Middle TextIcon Translucent" onclick="map.zoom(null, 0);">[]</button>
		<button id="zoomInButton" class="RightPill TextIcon Translucent" onclick="map.zoom(null, 2);">+</button>
	</div>
</body>
</html>