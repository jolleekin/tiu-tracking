function TMap(){var C=0.002;var m=5;var o=8;var b=40;var A=b*0.005;var x=b*0.006;var F=1.05;var u="url(images/closedhand_8_8.cur), move";if(browser.isFirefox){o=2;A=b*0.004;F=1.06}else{if(browser.isChrome){u="move"}}var d=this;var l=csLoading;var k=null;var t=new TVector2D();var v=0;var h=new TVector2D();var I=0;var a=0;var H=A;var P={position:new TVector2D(),velocity:new TVector2D(),isLeftButtonDown:false};var s={position:new TVector2D(),targetPosition:new TVector2D(),scale:1,targetScale:1,totalScale:1};var N=new TTimer(b,function(){j();H*=F});var w=[];var M=null;var c=document.createElement(SDiv);c.setAttribute("style","position: absolute; z-index: 0; overflow: hidden; background-color: rgba(255, 255, 255, 0);");document.body.appendChild(c);var z=document.createElement(SDiv);z.style.position="absolute";c.appendChild(z);var O={type:"opacity",unit:"",to:100,step:10,delay:25,onfinish:function(){if(parseFloat(this.style.opacity)==0){this.style.visibility=SHidden}}};var J=TInfoBox();J.style.zIndex=101;J.style.opacity=0;J.style.color="#0860B6";z.appendChild(J);$fx(J).fxAdd(O);var e=TInfoBox();e.style.zIndex=100;z.appendChild(e);h.x=c.offsetWidth*0.5;h.y=c.offsetHeight*0.5;mapMouseDown=function(Q){if(Q.button==0){N.setEnabled(false);P.isLeftButtonDown=true;r(Q,false);Q.preventDefault()}};mapMouseMove=function(Q){r(Q,true);if(P.isLeftButtonDown){this.style.cursor=u;s.targetPosition.add(P.velocity);s.position.assign(s.targetPosition);L();Q.preventDefault()}};mapMouseUp=function(S){if(S.button==0){this.style.cursor="default";P.isLeftButtonDown=false;r(S,false);if(!P.velocity.equals(ZeroVector2D,m)){s.targetPosition.multAddSet(s.position,P.velocity,o);H=A;N.setEnabled(true)}else{d.selectEntity(null);if(d.onClick){var R=1/s.totalScale;var Q=(P.position.x-s.position.x)*R;var T=(P.position.y-s.position.y)*R;d.onClick(Q,T)}}}};mapMouseWheel=function(R){var S=R.detail?-R.detail:R.wheelDelta;var Q=0.5;if(S>0){Q=2}d.zoom(R,Q);R.preventDefault()};mapDoubleClick=function(Q){d.zoom(Q,2);Q.preventDefault()};function p(Q){var R=Q.touches[0];Q.pageX=R.pageX;Q.pageY=R.pageY;Q.button=0}function y(Q){p(Q);mapMouseDown(Q)}function i(Q){p(Q);mapMouseUp(Q)}function K(Q){p(Q);mapMouseMove(Q)}function E(){if(this!=M){J.setContent(this.getInfo());J.setPosition(this.mX,this.mY,0,-this.offsetHeight,s.totalScale);J.style.visibility=SVisible;O.to=100;J.fxRun()}}function G(){O.to=0;J.fxRun()}function D(Q){d.selectEntity(this);Q.stopPropagation()}function g(){if(k){var Q=c.offsetWidth/t.x;var R=c.offsetHeight/t.y;I=Math.min(Q,R)*0.45}else{I=1}a=4*I}function B(){s.scale=0.001;s.targetScale=I;s.totalScale=s.scale*v;s.position.multSubSet(h,t,s.scale);s.targetPosition.multSubSet(h,t,s.targetScale);H=A;N.setEnabled(true)}function n(R){var Q=new TVector2D();Q.multAddSet(s.position,R,s.totalScale);return Q}function r(S,R){if(S){var Q=S.pageX-c.offsetLeft;var T=S.pageY-c.offsetTop;if(R){P.velocity.x=Q-P.position.x;P.velocity.y=T-P.position.y}P.position.x=Q;P.position.y=T}else{P.position.assign(h)}}function j(){var Q=true;if(!s.position.equals(s.targetPosition,1)){Q=false;s.position.lerp(s.position,s.targetPosition,H);L()}var S=s.targetScale-s.scale;if(!isZero(S,C)){Q=false;s.scale+=S*H;s.totalScale=s.scale*v;q();J.onScaleChange(s.totalScale);e.onScaleChange(s.totalScale);for(var R=0;R<w.length;R++){w[R].onScaleChange(s.totalScale)}}if(Q){N.setEnabled(false);if(l==csLoading){l=csLoaded;c.ondblclick=mapDoubleClick;c.onmousedown=mapMouseDown;c.onmousemove=mapMouseMove;c.onmouseup=mapMouseUp;c.onmousewheel=mapMouseWheel;c.addEventListener("DOMMouseScroll",mapMouseWheel,false);if(typeof TouchEvent!=SUndefined){c.ontouchstart=y;c.ontouchmove=K;c.ontouchend=i}if(d.onLoad){d.onLoad()}}}}this.setMapImage=function(R,Q){if((k!=R)&&R){if(k){z.removeChild(k)}v=Q;t.x=R.width*0.5;t.y=R.height*0.5;R.style.position="absolute";R.style.boxShadow="rgba(0,0,0,0.3) 0 0 4px 4px";z.insertBefore(R,z.firstChild);k=R;g();B()}};this.setGrid=function(Q,R){};function L(){z.style.left=s.position.x+SPixel;z.style.top=s.position.y+SPixel}function q(){k.style.width=2*t.x*s.scale+SPixel;k.style.height=2*t.y*s.scale+SPixel}this.invalidate=function(){L();if(k){q()}for(var Q=0;Q<w.length;Q++){w[Q].onScaleChange(s.totalScale)}};this.zoom=function(R,Q){if(Q<0){return}r(R,false);if(Q>0){s.targetScale=ensureRange(s.scale*Q,I,a);s.targetPosition.lerp(P.position,s.position,s.targetScale/s.scale)}else{s.targetScale=I;s.targetPosition.multSubSet(P.position,t,s.targetScale)}if(!(s.position.equals(s.targetPosition,m)&&isZero(s.scale-s.targetScale,C))){H=x;N.setEnabled(true)}};this.setRect=function(S,T,V,Q){var R=V-S;var U=Q-T;h.x=R*0.5;h.y=U*0.5;s.position.x-=S-c.offsetLeft;s.position.y-=T-c.offsetTop;s.targetPosition.assign(s.position);c.style.left=S+SPixel;c.style.top=T+SPixel;c.style.width=R+SPixel;c.style.height=U+SPixel;g();if(l==csLoaded){L()}};this.bringToCenter=function(Q){if(Q&&(Q.parentNode==z)){s.targetPosition.x=h.x-Q.mX*s.totalScale;s.targetPosition.y=h.y-Q.mY*s.totalScale;H=A;N.setEnabled(true)}};this.addEntity=function(Q){if(Q&&(Q.parentNode!=z)){Q.addEventListener(SClick,D,false);Q.addEventListener(SMouseOut,G,false);Q.addEventListener(SMouseOver,E,false);w.push(Q);z.appendChild(Q);Q.onScaleChange(s.totalScale)}};this.selectEntity=function(U){if(U!=M){if(U){J.style.visibility=SHidden;e.setContent(U.getInfo());e.setPosition(U.mX,U.mY,0,-U.offsetHeight,s.totalScale);e.style.visibility=SVisible;var R=U.offsetLeft,Y=U.offsetTop,aa=U.offsetWidth+R,V=U.offsetHeight+Y,S=e.offsetLeft,Z=e.offsetTop,ac=e.offsetWidth+S,W=e.offsetHeight+Z,T=Math.min(R,S)+z.offsetLeft,ab=Math.min(Y,Z)+z.offsetTop,Q=Math.max(aa,ac)+z.offsetLeft,X=Math.max(V,W)+z.offsetTop;if((T<0)||(ab<0)||(Q>c.offsetWidth)||(X>c.offsetHeight)){d.bringToCenter(U)}}else{e.style.visibility=SHidden}M=U;if(d.onSelectChange){d.onSelectChange()}}};function f(Q){Q.removeEventListener(SClick,D,false);Q.removeEventListener(SMouseOut,G,false);Q.removeEventListener(SMouseOver,E,false);z.removeChild(Q)}this.deleteEntity=function(Q){checkRange(Q,0,w.length-1);f(w.splice(Q,1)[0])};this.removeEntity=function(Q){this.deleteEntity(w.indexOf(Q))};this.removeAll=function(){for(var R=0,Q;R<w.length;R++){f(Q)}w.length=0};this.getEntity=function(Q){checkRange(Q,0,w.length-1);return w[Q]};this.getEntityCount=function(){return w.length};this.getSelectedEntity=function(){return M};this.getScale=function(){return s.totalScale};this.onLoad=null;this.onSelectChange=null;this.onClick=null};