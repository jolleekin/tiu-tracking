var etDetector=0;var etTag=1;var EntityNames=["detector","tag"];var EntityClassNames=["TDetector","TTag"];function AJAX(e,b,d){function a(g){try{if(this.mMethod=="POST"){this.open(this.mMethod,this.mUrl,true);this.setRequestHeader("Content-type","application/x-www-form-urlencoded");this.send(g)}else{this.open(this.mMethod,this.mUrl+"?"+g,true);this.send()}}catch(f){console.log("AJAX failed")}}var c=new XMLHttpRequest();c.mMethod=e;c.mUrl=b;c.onreadystatechange=d;c.doSend=a;return c}var rsOK=0;var rsSessionEnd=1;var rsInvalidArgument=2;function processResponse(ajax,entityType){var response;var table=tagTable;var entities=tags;if(entityType==etDetector){table=detectorTable;entities=detectors}if(ajax.readyState==4&&ajax.status==200){response=eval(ajax.responseText);if(!response){return}if(response.request=="login"){loginButton.disabled=false;if(response.status==rsOK){updateUI(true);showMessage(mtInfo,null,true)}else{showMessage(mtError,response.data,true)}return}if(response.status!=rsOK){deleteRowIndex=-1;if(response.status==rsSessionEnd){updateUI(false)}showMessage(mtError,response.data,true);return}if(response.request.indexOf("get")>-1){doGet()}else{if(response.request.indexOf("add")>-1){doAdd()}else{doDelete()}}}function doDelete(){table.deleteRow(deleteRowIndex);map.removeEntity(entities.splice(deleteRowIndex,1)[0]);deleteRowIndex=-1}function doAdd(){var entity=null,row;var info=response.data;info.b=BatteryStatus[info.b];for(var i=0;i<entities.length;i++){if(entities[i].mId==info.i){entity=entities[i];break}}if(entity){row=entity.mLinkedRow;if(entityType==etTag){row.cells[1].innerHTML=info.a;row.cells[2].innerHTML=info.x.toFixed(1);row.cells[3].innerHTML=info.y.toFixed(1)}else{row.cells[1].innerHTML=info.x.toFixed(1);row.cells[2].innerHTML=info.y.toFixed(1)}entity.setPosition(info.x,info.y,map.getScale())}else{row=table.insertRow(-1);entity=TMapEntity(entityType);var columnNames=["Id","X","Y","Battery","More"];var cellValues=[info.i,info.x.toFixed(1),info.y.toFixed(1),info.b,""];if(entityType==etTag){columnNames.splice(1,0,"AssetId");cellValues.splice(1,0,info.a)}var j,cell;for(j=0;j<cellValues.length;j++){cell=row.insertCell(-1);cell.innerHTML=cellValues[j];cell.className="Col "+columnNames[j]}cell.appendChild(createDeleteButton(entityType,row,table));row.mLinkedEntity=entity;entity.set(info,row,table);entities.push(entity);map.addEntity(entity)}map.selectEntity(null);map.selectEntity(entity)}function doGet(){var columnNames=["Id","X","Y","Battery","More"];if(entityType==etTag){columnNames.splice(1,0,"AssetId")}var newEntityCount=response.data.length-1;var curEntityCount=entities.length;if(newEntityCount<curEntityCount){for(var i=curEntityCount-1;i>=newEntityCount;i--){map.removeEntity(entities[i]);detectorTable.deleteRow(-1);entities[i]=null}}entities.length=newEntityCount;var row,entity,info,cellValues,cell;for(var i=0;i<newEntityCount;i++){info=response.data[i];info.b=BatteryStatus[info.b];cellValues=[info.i,info.x.toFixed(1),info.y.toFixed(1),info.b,"&nbsp;"];if(entityType==etTag){cellValues.splice(1,0,info.a)}if(!entities[i]){entity=TMapEntity(entityType);entities[i]=entity;map.addEntity(entity);row=table.insertRow(-1);for(var j=0;j<cellValues.length;j++){cell=row.insertCell(-1);cell.innerHTML=cellValues[j];cell.className="Col "+columnNames[j]}if(isLoggedIn){cell.innerHTML="";cell.appendChild(createDeleteButton(entityType,row,table))}}else{entity=entities[i];row=table.getElement().rows[i];for(var j=0;j<cellValues.length-1;j++){cell=row.cells[j];cell.innerHTML=cellValues[j]}}row.mLinkedEntity=entity;entity.set(info,row,table);map.invalidate()}}}var headerPanel,tabControl,tabPanel;var welcomeTab,assetsTab,detectorsTab;var map,mapImage,mapToolbar;var tags=[],detectors=[];var tagTable,detectorTable;var activeTable;var tagUpdateTimer;var loginDialog;var usernameTextBox;var passwordTextBox;var loginButton;var msgLabel;var loggedInDialog;var isLoggedIn=false;var buttonAnimationParams={type:"left",unit:"px",to:0,step:24,delay:20};var panelAnimationParams={type:"left",unit:"px",to:0,step:25,delay:20};var msgLabelAnimationParams={type:"opacity",to:100,step:10,delay:25,fadeOut:true,fadeOutTimeOut:4000,onfinish:function(){var a=msgLabelAnimationParams;if(a.to==0){a.to=100}else{if(a.fadeOut){a.to=0;a.timerHandle=setTimeout(this.fxRun,a.fadeOutTimeOut)}}}};var mtInfo=0,mtError=1;var StatusColors=["#04F","#F40"];function showMessage(a,c,b){clearTimeout(msgLabelAnimationParams.timerHandle);if(c!=null){if(msgLabelAnimationParams.to==0){msgLabelAnimationParams.to=100}msgLabelAnimationParams.fadeOut=b;msgLabel.style.color=StatusColors[a];msgLabel.innerHTML=c}else{msgLabelAnimationParams.to=0;msgLabelAnimationParams.fadeOut=false}msgLabel.fxRun()}var BatteryStatus=["Normal","Low!"];var deleteRowIndex=-1;var loginRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,-1)});var tagRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,etTag)});var detectorRequestManager=AJAX("POST","TIUTracking.php",function(){processResponse(this,etDetector)});function login(){if(usernameTextBox.value==""){showMessage(mtError,"Please enter the username.",true);return}if(passwordTextBox.value==""){showMessage(mtError,"Please enter the password.",true);return}showMessage(mtInfo,"Logging in...",false);loginButton.disabled=true;loginRequestManager.doSend("request=login&username="+usernameTextBox.value+"&password="+passwordTextBox.value);usernameTextBox.value="";passwordTextBox.value=""}function logout(){loginRequestManager.doSend("request=logout");updateUI(false)}function createDeleteButton(e,f,d){function c(i){if(deleteRowIndex==-1){deleteRowIndex=this.mLinkedRow.rowIndex;var g=this.mEntityType;var b=EntityNames[g];if(confirm("Delete this "+b+" permanently?")){var h=this.mEntityType==etTag?tagRequestManager:detectorRequestManager;h.doSend("request=del-"+b+"&"+b+"-id="+this.mLinkedRow.mLinkedEntity.mId)}}else{showMessage(mtError,"Please wait for the current request to finish.",true)}i.stopPropagation()}var a=newElement(SDiv,"DeleteButton");a.mEntityType=e;a.mLinkedTable=d;a.mLinkedRow=f;a.onclick=c;a.title="Delete";return a}function updateUI(a){if(isLoggedIn==a){return}var h=$("mapUploadFrame");h.style.display=a?SBlock:SNone;if(h.contentWindow){h.contentWindow.location.reload()}else{frames.mapUploadFrame.location.reload()}var f,e=[tagTable.getElement(),detectorTable.getElement()];if(a){$("greetingLabel").innerHTML='Hi <strong style="color: blue;">'+getCookie("username")+"</strong>";loggedInDialog.style.display=SBlock;loginDialog.style.display=SNone;for(var c=0;c<e.length;c++){f=e[c];for(var b=0,g;b<f.rows.length;b++){g=f.rows[b];g.lastChild.innerHTML="";g.lastChild.appendChild(createDeleteButton(c,g,f))}}h=document.createElement(SDiv);h.id="addModifyTagDialog";h.setAttribute("style","float: left; width: 315px; background-color: #EEF; margin-top: 3px;");h.innerHTML='<div style="float: left;"><input type="textbox" id="tTextBox" class="Col Id Cell" placeholder="ID" /><input type="textbox" id="aTextBox" class="Col AssetId Cell" placeholder="Asset ID" /></div><button id="addTagButton" style="margin-left: 0.5em; width: 50px;">Add</button>';assetsTab.appendChild(h);$("addTagButton").onclick=function(){var i=$("tTextBox"),d=$("aTextBox");if(i.value==""){showMessage(mtError,"Please enter tag ID",true)}else{if(d.value==""){showMessage(mtError,"Please enter asset ID",true)}else{tagRequestManager.doSend("request=add-tag&tag-id="+i.value+"&asset-id="+d.value);i.value=d.value=""}}};h=document.createElement(SDiv);h.id="addModifyDetectorDialog";h.title="Click on the map to place the detector";h.setAttribute("style","float: left; width: 189px; background-color: #EEF; margin-top: 3px;");h.innerHTML='<div style="float: left;"><input type="textbox" id="dTextBox" class="Col Id Cell" placeholder="ID" /><input type="textbox" id="xTextBox" class="Col X Cell" placeholder="X" /><input type="textbox" id="yTextBox" class="Col Y Cell" placeholder="Y" /></div><button id="addDetectorButton" style="margin-left: 0.5em; width: 50px;">Add</button>';detectorsTab.appendChild(h);$("addDetectorButton").onclick=function(){var j=$("dTextBox"),i=$("xTextBox"),k=$("yTextBox");if(j.value==""){showMessage(mtError,"Please enter detector ID",true)}else{if(i.value==""||k.value==""){showMessage(mtError,"Please enter detector's location",true)}else{detectorRequestManager.doSend("request=add-detector&detector-id="+j.value+"&x="+i.value+"&y="+k.value);j.value=i.value=k.value=""}}};map.onClick=function(d,i){$("xTextBox").value=d.toFixed(1);$("yTextBox").value=i.toFixed(1)}}else{loginDialog.style.display=SBlock;loggedInDialog.style.display=SNone;for(var c=0;c<e.length;c++){f=e[c];for(var b=0;b<f.rows.length;b++){f.rows[b].lastChild.innerHTML="&nbsp;"}}h=$("addModifyTagDialog");if(h){assetsTab.removeChild(h)}h=$("addModifyDetectorDialog");if(h){detectorsTab.removeChild(h)}map.onClick=null}isLoggedIn=a}function TMapEntity(e){function g(j,i,h){this.mId=j.i;this.mX=j.x;this.mY=j.y;this.mBattery=j.b;this.mLinkedRow=i;this.mLinkedTable=h;if(j.a){this.mTimestamp=j.s;this.mAssetId=j.a}}function c(h,j,i){this.mX=h;this.mY=j;this.onScaleChange(i)}function a(h){this.style.left=(this.mX*h-this.firstChild.offsetWidth*0.5)+SPixel;this.style.top=(this.mY*h-this.offsetHeight)+SPixel}function f(){return'<table cellspacing="0" style="border-collapse: collapse; width: 100%;"><caption style="color: Red; font-weight: bold;">Tag</caption><tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mId+'</td></tr><tr style="border: none;"><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mAssetId+'</td></tr><tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mBattery+"</td></tr></table>"}function d(){return'<table cellspacing="0" style="border-collapse: collapse; width: 100%;"><caption style="color: Red; font-weight: bold;">Detector</caption><tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mId+'</td></tr><tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">'+this.mBattery+"</td></tr></table>"}var b=newElement(SDiv,"TMapEntity");b.style.zIndex=e;b.appendChild(newElement(SDiv,EntityClassNames[e]));b.set=g;b.setPosition=c;b.onScaleChange=a;if(e==etTag){b.getInfo=f}else{b.getInfo=d}return b}function requestTagsInfo(){tagRequestManager.doSend("request=get-tags")}function adjusMapRect(){map.setRect(tabPanel.offsetLeft+tabPanel.offsetWidth,headerPanel.offsetHeight,window.innerWidth,window.innerHeight)}function getCookie(f){var c,b,a,e,d=document.cookie.split(";");for(c=0;c<d.length;c++){b=d[c].indexOf("=");a=d[c].substr(0,b);e=d[c].substr(b+1);a=a.replace(/^\s+|\s+$/g,"");if(a==f){return unescape(e)}}return null}onresize=function(){adjusMapRect();mapToolbar.style.left=(window.innerWidth-mapToolbar.offsetWidth-10)+SPixel;mapToolbar.style.top=(window.innerHeight-mapToolbar.offsetHeight-10)+SPixel;tabPanel.style.height=(window.innerHeight-headerPanel.offsetHeight)+SPixel};onload=function(){headerPanel=$("headerPanel");tabPanel=$("tabPanel");$fx(tabPanel).fxAdd(panelAnimationParams);tabControl=new TTabControl(tabPanel);welcomeTab=$("welcomeTab");assetsTab=$("assetsTab");detectorsTab=$("detectorsTab");loginDialog=$("loginDialog");usernameTextBox=$("usernameTextBox");passwordTextBox=$("passwordTextBox");loginButton=$("loginButton");loggedInDialog=$("loggedInDialog");msgLabel=$("msgLabel");$fx(msgLabel).fxAdd(msgLabelAnimationParams);var c=null;if(browser.isIE){c="Internet Explorer"}else{if(browser.isFirefox){c="Mozilla Firefox"}}if(c!=null){showMessage(mtInfo,"You are using <strong>"+c+'</strong>.<br />For the best experience, please use <a href="http://www.google.com/chrome/intl/en/make/download.html?brand=CHKZ" target="_blank" style="font-weight: bold;">Google Chrome</a>',true)}function a(){var f=this.getSelectedRow();if(this==activeTable||f!=null){var e=f?f.mLinkedEntity:null;map.selectEntity(e)}}tagTable=new TFlexTable($("assetsTab"));tagTable.attachTextBox($("assetSearchBox"),1);tagTable.onSelectChange=a;detectorTable=new TFlexTable($("detectorsTab"));detectorTable.attachTextBox($("detectorSearchBox"),0);detectorTable.onSelectChange=a;activeTable=tagTable;mapToolbar=$("mapToolbar");map=new TMap();map.onLoad=function(){mapToolbar.style.visibility=SVisible};map.onSelectChange=function(){var f=-1;var g=this.getSelectedEntity();if(g){var i=g.mLinkedTable;if(activeTable!=i){var h=activeTable;activeTable=i;h.setSelectedIndex(-1)}f=g.mLinkedRow.rowIndex}activeTable.setSelectedIndex(f)};mapImage=new Image();mapImage.src="images/FloorPlan.jpg?"+(new Date()).getTime();mapImage.onload=function(){map.setMapImage(this,120)};tagUpdateTimer=new TTimer(2000,requestTagsInfo);tagUpdateTimer.setEnabled(true);requestTagsInfo();detectorRequestManager.doSend("request=get-detectors");var b=$("showHideTabPanelButton");b.style.left=(tabPanel.offsetWidth-b.offsetWidth-3)+SPixel;b.style.top=(tabPanel.offsetTop+3)+SPixel;b.onclick=function(){if(this.offsetLeft>0){this.innerHTML="»";this.className="TextIcon TCastShadow";this.title="Show panel";panelAnimationParams.to=-tabPanel.offsetWidth;panelAnimationParams.onfinish=null;buttonAnimationParams.to=0;map.setRect(0,headerPanel.offsetHeight,window.innerWidth,window.innerHeight)}else{this.innerHTML="«";this.className="TextIcon";this.title="Hide panel";panelAnimationParams.to=0;panelAnimationParams.onfinish=adjusMapRect;buttonAnimationParams.to=tabPanel.offsetWidth-this.offsetWidth-3}this.fxRun();tabPanel.fxRun()};$fx(b).fxAdd(buttonAnimationParams);function d(h,l,k){var j=map.getSelectedEntity();if(j&&j.firstChild.className==h){map.selectEntity(null)}var f=k?SVisible:SHidden;var g=h=="TTag"?1:2;tabControl.setTabVisible(g,k);for(var g=0;g<l.length;g++){l[g].style.visibility=f}}$("showAssetsCheckBox").onchange=function(){d("TTag",tags,this.checked)};$("showDetectorsCheckBox").onchange=function(){d("TDetector",detectors,this.checked)};onresize();if(getCookie("username")){updateUI(true)}};function changeMapImage(){var b=$("mapUploadFrame").contentWindow.document.getElementsByTagName("label")[0].innerHTML;if(b!=""){var a=JSON.parse(b);if(a){if(a.status==0){mapImage=new Image();mapImage.src="images/FloorPlan.jpg?"+(new Date()).getTime();mapImage.onload=function(){map.setMapImage(this,120)}}else{showMessage(mtError,a.data,true)}}}};