<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Asset Tracking System</title>
	<link rel="shortcut icon" href= "favicon.ico">
	<script type="application/x-javascript">
		var headerPanel;
		var tabControl;
		var elTabPanel;
		
		var map;
		var elMapImage;
		var elMapToolbar;
		
		var toolTip;
		var assets = [];
		var assetTable;
		
		var detectors = [];
		var detectorTable;
		var elDetectorTable;

		var ajax;
		var updateTimer;
		
		var logInDialog;
		var usernameTextBox;
		var passwordTextBox;
		var loginButton;
		var loggedInDialog;
		
		var isLoggedIn = false;
		
		var buttonAnimationParams = {type: 'left', unit: 'px', to: 0, step: -24, delay: 20};
		var panelAnimationParams = {
			type: 'left',
			unit: 'px',
			to: 0,
			step: -25,
			delay: 20
		};
		//var buttonAnimation = {type: 'left', to: 0, step: -24, delay: 20};
		//var panelAnimation = {type: 'left', to: -elTabPanel.offsetWidth, step: -25, delay: 10};
		var toolTipAnimationParams = {
			type: 'opacity',
			unit: '',
			to: 100,
			step: 5,
			delay: 20,
			onfinish: function () {
				if (parseFloat(this.style.opacity) == 0)
					this.style.visibility = SHidden;	// Hide the box to prevent it from receiving events
			}
		};
		
		function logInOut(isIn) {
			
			function showLoginStatus(color, text) {
				var label = $('loginStatusLabel');
				label.style.color = color;
				label.innerHTML = text;
				if (text != '') {
					$fx(label).fxAdd({
						type: 'opacity',
						to: 100,
						step: 10,
						delay: 50,
						onfinish: setTimeout("$fx('#loginStatusLabel').fxAdd({type: 'opacity', to: 0, step: -10, delay: 50, onfinish: function() {this.innerHTML = '';}}).fxRun();", 2000)
					}).fxRun();
				}
			}
			
			if (isIn) {
				if (usernameTextBox.value == '') {
					showLoginStatus('Red', 'Please enter the username.');
					return;
				}
				if (passwordTextBox.value == '') {
					showLoginStatus('Red', 'Please enter the password.');
					return;
				}
				
				showLoginStatus('Blue', 'Logging in...');
				loginButton.disabled = true;
				
				AJAX(SPost, 'TIUTracking.php', 'q=login&username=' + usernameTextBox.value + '&password=' + passwordTextBox.value, function () {
						if (this.readyState == 4 && this.status == 200) {
							if (this.responseText == 'OK') {
								showLoginStatus('Blue', '');
								isLoggedIn = true;
								updateUI();
							} else
								showLoginStatus('Red', this.responseText);
						} else
							showLoginStatus('Red', 'Error connecting to server.');
						loginButton.disabled = false;
					}, null
				);
			} else {
				AJAX(SPost, 'TIUTracking.php', 'q=logout', null);
				isLoggedIn = false;
				updateUI();
			}
		}
		
		function updateUI() {
			var assetTableElement = assetTable.getElement();
			if (isLoggedIn) {
				$('usernameLabel').innerHTML = 'Hi <strong style="color: blue;">' + usernameTextBox.value + '</strong>';
				loggedInDialog.style.display = SBlock;
				logInDialog.style.display = SNone;
				usernameTextBox.value = '';
				passwordTextBox.value = '';
				
				for (var i = 0, row; i < assetTableElement.rows.length; i++) {
					row = assetTableElement.rows[i];

					var removeButton = newElement('div', 'DeleteButton');
					removeButton.linkedRow = row;
					removeButton.title = 'Delete this asset';
					removeButton.onclick = function (event) {
						if (confirm("You're about to delete this asset permanently.")) {
							AJAX(SPost, 'TIUTracking.php', 'q=del_asset&tagId=' + this.linkedRow.cells[0].innerHTML, function () {
								if (this.readyState == 4 && this.status == 200) {
									// The server returns the id of the deleted tag or 0 if none.
									var tagId = parseInt(this.responseText);
									if (tagId > 0) {
										console.log(idx);
										assetTable.deleteRow(idx);
										assets.splice(idx, 1);
										map.removeEntity(idx);										
									} else
										alert('Could not delete this asset. Please try again.');
								}
							}, {rowIndex: row.rowIndex});
						}
						event.stopPropagation();
					}
					row.lastChild.innerHTML = '';
					row.lastChild.appendChild(removeButton);
				}
			} else {
				logInDialog.style.display = SBlock;
				loggedInDialog.style.display = SNone;
				
				for (var i = 0; i < assetTableElement.rows.length; i++)
					assetTableElement.rows[i].lastChild.innerHTML = '&nbsp;';
			}
		}
		
		function update() {
			//ajax.open('GET', 'AssetInfo.php?id=', true);
			//ajax.send();
			var count = 10;
			
			function mapEntityMouseOver() {
				toolTip.setContent(this.toHtml());
				toolTip.setPosition(this.offsetLeft, this.offsetTop);
				toolTip.style.visibility = SVisible;
				toolTipAnimationParams.to = 100;
				toolTipAnimationParams.step = 5;
				toolTip.fxRun();
			}
			
			function mapEntityMouseOut() {
				toolTipAnimationParams.to = 0;
				toolTipAnimationParams.step = -5;
				toolTip.fxRun();
			}
			
			function mapEntityClick() {
				this.linkedTable.setSelectedIndex(this.linkedRow.rowIndex);
			}
			
			function mapEntityDraw(scale) {
				this.style.left = (this.x * scale - 12) + SPixel;
				this.style.top  = (this.y * scale - this.offsetHeight) + SPixel;
			}
			
			function assetToHtml () {
				return	'<table cellspacing="0" style="border-collapse: collapse;">' +
						'<tr><td>Tag ID</td><td>&nbsp;:&nbsp;</td><td class="TTagId">' + this.tagId + '</td></tr>' +
						'<tr><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td>' + this.assetId + '</td></tr>' +
						'<tr><td>Battery</td><td>&nbsp;:&nbsp;</td><td>' + this.battery + '</td></tr></table>';
			}
		
			function rowClick() {
				this.linkedEntity.onclick();
				map.bringToCenter(this.linkedEntity);
			}
			
			// Table header
			cssClasses = ['TagId', 'AssetId', 'X', 'Y', 'Battery', 'More'];
			
			// Fake asset.
			for (var i = 0, row, asset; i < count; i++) {
				row = assetTable.insertRow(-1);
				
				asset = newElement(SDiv, 'TMapEntity');
				asset.appendChild(newElement(SDiv, 'TAssetIcon'));
				asset.tagId = i;
				asset.assetId = randomId();
				asset.timestamp = '2011-04-21 20:21:22';
				asset.x = Math.round(23 * Math.random());
				asset.y = Math.round(9 * Math.random());
				asset.battery = SNormal;
				
				asset.onmouseout  = mapEntityMouseOut;
				asset.onmouseover = mapEntityMouseOver;
				asset.onclick = mapEntityClick;
				asset.draw = mapEntityDraw;
				asset.toHtml = assetToHtml;
				
				// Link the asset with the corresponding row the the asset table.
				asset.linkedTable = assetTable;
				asset.linkedRow = row;
				row.linkedEntity = asset;
				row.addEventListener('click', rowClick, false);

				assets.push(asset);
				map.addEntity(asset);
				
				var cellValues = [asset.tagId, asset.assetId, asset.x, asset.y, asset.battery, '&nbsp;'];
				for (var j = 0; j < cellValues.length; j++) {
					var cell = row.insertCell(-1);
					cell.innerHTML = cellValues[j];
					cell.className = 'Col ' + cssClasses[j];
				}
			}
			map.addEntity(toolTip);
			toolTip.style.opacity = 0;
			toolTip.style.visibility = SVisible;
			//assetTable.setMaxRowCount(10);
		}
		
		function randomId() {
			var result = '';
			var hexDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
			for (var i = 0; i < 2; i++) {
				for (var j = 0; j < 4 + i; j++) {
					result += hexDigits[Math.floor(Math.random() * 15)];
				}
				result += '-';
			}
			for (var j = 0; j < 6; j++) {
				result += hexDigits[Math.floor(Math.random() * 15)];
			}
			return result;
		}
		
		function adjusMapRect() {
			map.setRect(elTabPanel.offsetLeft + elTabPanel.offsetWidth, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
		}
		
		onresize = function () {
			adjusMapRect();
			elMapToolbar.style.left = (window.innerWidth - elMapToolbar.offsetWidth - 10) + SPixel;
			elMapToolbar.style.top  = (window.innerHeight - elMapToolbar.offsetHeight - 10) + SPixel;
			elTabPanel.style.height = (window.innerHeight - headerPanel.offsetHeight) + SPixel;
		}
		
		onload = function () {
			headerPanel = $('headerPanel');
			
			elTabPanel = $('elTabPanel');
			$fx(elTabPanel).fxAdd(panelAnimationParams);
			
			tabControl = new TTabControl(elTabPanel);
		
			logInDialog = $('logInDialog');
			usernameTextBox = $('usernameTextBox');
			passwordTextBox = $('passwordTextBox');
			loginButton = $('loginButton');
			loggedInDialog = $('loggedInDialog');
		
			assetTable = new TFlexTable($('assetsTab'));
			assetTable.attachTextBox($('assetSearchBox'), 1);
			
			elDetectorTable = $('elDetectorTable');
			detectorTable = new TFlexTable($('detectorsTab'));
			detectorTable.attachTextBox($('detectorSearchBox'));
			
			elMapToolbar = $('elMapToolbar');

			toolTip	= newInfoBox();
			$fx(toolTip).fxAdd(toolTipAnimationParams);
			
			map = new TMap();
			map.onLoad = function () {
				elMapToolbar.style.visibility = SVisible;
			}
			
			elMapImage = new Image();
			elMapImage.src = 'images/FloorPlan.jpg';
			elMapImage.onload = function () {
				map.setMapImage(this, 120);
			}

			ajax = new XMLHttpRequest();
			ajax.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					var data = eval(this.responseText);
					assets.length = asset.length;
					for (var i = 0; i < asset.length; i++) {
						if (assets[i])
							assets[i].assign(data[i]);
						else
							assets[i] = new TAssetTag(data[i]);
					}
				}
			}
			
			//updateTimer = new TTimer(5000, update});
			//updateTimer.setEnabled(true);
			
			update();
			
			/*------------------------------------*/
			
			var button = $('showHideTabPanelButton');
			button.style.left = (elTabPanel.offsetWidth - button.offsetWidth - 3) + SPixel;
			button.style.top  = (elTabPanel.offsetTop + 3) + SPixel;
			button.onclick = function () {
				if (this.offsetLeft > 0) {
					this.innerHTML = '»';
					this.className = 'TextIcon TCastShadow';
					this.title = 'Show panel';

					panelAnimationParams.to = -elTabPanel.offsetWidth;
					panelAnimationParams.step = -25;
					panelAnimationParams.onfinish = null;

					buttonAnimationParams.to = 0;
					buttonAnimationParams.step = -24;

					map.setRect(0, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
				} else {
					this.innerHTML = '«';
					this.className = 'TextIcon';
					this.title = 'Hide panel';
					
					panelAnimationParams.to = 0;
					panelAnimationParams.step = 25;
					panelAnimationParams.onfinish = adjusMapRect;
				
					buttonAnimationParams.to = elTabPanel.offsetWidth - this.offsetWidth - 3;
					buttonAnimationParams.step = 23;
				}
		
				elTabPanel.fxRun();
				this.fxRun();
			}
			$fx(button).fxAdd(buttonAnimationParams);
			
			$('showAssetsCheckBox').onchange = function () {
				var v = this.checked ? SVisible : SHidden;
				tabControl.setTabVisible(1, this.checked);
				for (var i = 0; i < assets.length; i++)
					assets[i].style.visibility = v;
			}
			
			$('showDetectorsCheckBox').onchange = function () {
				tabControl.setTabVisible(2, this.checked);
				for (var i = 0; i < detectors.length; i++)
					detectors[i].style.visibility = v;
			}
			/*
			$('showGridCheckBox').onchange = function () {
				$('gridSpacingTextBox').disabled = !this.checked;
			}
			*/

			onresize();
		}
	</script>
	<link href="TIUTracking.css" rel="stylesheet" type="text/css"/>
	<script type="application/x-javascript" src="js/AssetTag.js"></script>
	<script type="application/x-javascript" src="js/CellList.js"></script>
	<script type="application/x-javascript" src="js/Common.js"></script>
	<script type="application/x-javascript" src="js/FlexTable.js"></script>
	<script type="application/x-javascript" src="js/InfoBox.js"></script>
	<script type="application/x-javascript" src="js/Map.js"></script>
	<script type="application/x-javascript" src="js/TabControl.js"></script>
	<script type="application/x-javascript" src="js/Timer.js"></script>
	<script type="application/x-javascript" src="js/Vector2D.js"></script>
	<script type="application/x-javascript" src="js/fx-source.js"></script>
</head>
<body>
	<div id="headerPanel" class="TCastShadow" style="text-align: center;">
		Asset Tracking System
	</div>
	<button id="showHideTabPanelButton" class="TextIcon" title="Hide panel" style="position: absolute; z-index: 4; padding: 0 4px 2px;">«</button>
	<div id="elTabPanel" class="TTabPanel TCastShadow" style="	position: relative; left: 0; top: 0; margin: 0; padding: 0; z-index: 2; background-color: #FFF; width: 350px;">		
		<ul class="TTabNamePanel">
			<li class="TTabName">Settings</li>
			<li class="TTabName">&nbsp;&nbsp;Assets&nbsp;&nbsp;&nbsp;</li>
			<li class="TTabName">Detectors</li>
		</ul>
		<div class="TTabContentPanel">
			<div id="settingsTab" class="TTabContent" style="vertical-align: middle;">
				<fieldset id="logInDialog" class="HasBorder">
					<legend>Login</legend>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Username:</div><input id="usernameTextBox" type="textbox" maxlength="30" style="width: 150px;" /><br /></div>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Password:</div><input id="passwordTextBox" type="password" maxlength="30" style="width: 150px;" /><br /></div>
					<div><button id="loginButton" onclick="logInOut(true);">Log in</button><label id="loginStatusLabel" style="margin-left: 35px; opacity: 0;"></label></div>
				</fieldset>
				<div id="loggedInDialog" style="display: none;">
					<label id="usernameLabel" style="padding: 0 1em 0 0;"></label>
					<a id="logOutLink" href="javascript:logInOut(false);" style="padding: 0 1em; border-left: 1px solid #CCC;">Log out</a>
				</div>
				<br />
				<fieldset class="HasBorder">
					<legend>Options</legend>
					<input id="showAssetsCheckBox" type="checkbox" checked /><label for="showAssetsCheckBox">Show assets</label><br />
					<input id="showDetectorsCheckBox" type="checkbox" checked /><label for="showDetectorsCheckBox">Show detectors</label><br />
					<!--<input id="showGridCheckBox" type="checkbox" /><label for="showGridCheckBox">Show grid</label><div style="float: right;"><label>Grid spacing</label><input id="gridSpacingTextBox" type="textbox" value="1" disabled style="margin-left: 10px; width: 40px;" /></div><br />-->
				</fieldset>
			</div>
			<div id="assetsTab" class="TTabContent">
				<input type="textbox" id="assetSearchBox" class="TSearchBox" placeholder="Search for an asset"/>
				<div class="TableHeader"><div class="Col TagId">Tag ID</div><div class="Col AssetId">Asset ID</div><div class="Col X">X</div><div class="Col Y">Y</div><div class="Col Battery">Battery</div><div class="Col More"></div></div>
			</div>
			<div id="detectorsTab" class="TTabContent">
				<input type="textbox" id="detectorSearchBox" class="TSearchBox" placeholder="Search for a detector"/>
				<table id="elDetectorTable"></table>
			</div>
		</div>
	</div>
	<div id="elMapToolbar" class="TCastShadow">
		<button id="zoomOutButton" class="LeftPill TextIcon Translucent" title="Zoom out" onclick="map.zoom(null, 0.5);">-</button>
		<button id="zoomFitButton" class="Middle TextIcon Translucent" title="Zoom fit" onclick="map.zoom(null, 0);">[]</button>
		<button id="zoomInButton" class="RightPill TextIcon Translucent" title="Zoom in" onclick="map.zoom(null, 2);">+</button>
	</div>
</body>
</html>