<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Asset Tracking System</title>
	<link rel="shortcut icon" href= "favicon.ico">
	<script type="application/x-javascript">
		/**
		 *	Creates an AJAX object with 3 custom attributes (mMethod, mUrl, and doSend()).
		 *
		 *	@param	method	{String}	'GET' or 'POST'.
		 *	@param	url		{String}	The request url.
		 *	@param	callback	{Function}	The function to be called upon receiving the response.
		 */
		function AJAX(method, url, callback) {

			/**
			 *	Sends request with certain params.
			 *
			 *	@param	params	{String}	Params to send along, e.g. 'username=abc&password=123'
			 */
			function _doSend(params) {
				try {
					if (this.method == 'POST') {
						this.open(this.method, this.mUrl, true);
						this.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
						this.send(params);
					} else {

						this.open(this.method, this.mUrl + '?' + params, true);
						this.send();
					}
				} catch (e) {
					console.log('AJAX failed');
				}
			}
				
			var xhr = new XMLHttpRequest();
			xhr.mMethod = method;
			xhr.mUrl = url;
			xhr.onreadystatechange = callback;
			xhr.doSend = _doSend;

			return xhr;
		}
		
		var Host = 'TIUTracking.php';
		
		var headerPanel;
		var tabControl;
		var elTabPanel;
		
		var map;
		var elMapImage;
		var elMapToolbar;
		
		var toolTip;
		var assets = [];
		var assetTable;
		
		var detectors = [];
		var detectorTable;

		/**
		 *	An AJAX object for asset related requests, i.e. adding/changing/deleting an asset and getting all assets' info.
		 */
		var assetAjax = AJAX('POST', Host, function () {
			if (this.readyState == 4 && this.status == 200) {
				/*
					Data returned are in JSON format.
					[
						{
							s: String	// 'yyyy-mm-dd hh:ii:ss'
							t: Integer,	// Tag ID
							a: String,	// Asset ID
							x: Double,	// x location
							y: Double,	// y location
							b: Integer	// battery, 0 = normal
						},
						...
						{}	// Empty object
					]
				*/
				var data = eval(this.responseText);
				assets.length = data.length - 1;
				for (var i = 0, a, b; i < assets.length; i++) {
					if (!assets[i])
						assets[i] = TMapEntity();
					a = assets[i];
					b = data[i];
					a.mTimestamp = b.s;
					a.mTagId	= b.t;
					a.mAssetId	= b.a;
					a.mX		= b.x;
					a.mY		= b.y;
					a.mBattery	= b.b;
				}
			}
		});

		/**
		 *	An AJAX object for detector related requests, i.e. adding/changing/deleting an detector and getting all detectors' info.
		 */
		var detectorAjax = AJAX('POST', Host, function () {
			if (this.readyState == 4 && this.status == 200) {
				/*
					Data returned are in JSON format.
					[
						{
							d: Integer,	// Detector ID
							x: Double,	// x location
							y: Double,	// y location
							b: Integer	// battery, 0 = normal
						},
						...
						{}	// Empty object
					]
				*/
				var data = eval(this.responseText);
				detectors.length = data.length - 1;
				for (var i = 0, a, b; i < detector.length; i++) {
					if (!detectors[i])
						detectors[i] = TMapEntity();
					a = detectors[i];
					b = data[i];
					a.mDetectorId = b.t;
					a.mX		= b.x;
					a.mY		= b.y;
					a.mBattery	= b.b;
				}
			}
		});
		
		var assetInfoUpdateTimer;
		
		var loginDialog;
		var usernameTextBox;
		var passwordTextBox;
		var loginButton;
		var loginStatusLabel;
		var loggedInDialog;
		
		var isLoggedIn = false;
		
		var buttonAnimationParams = {
			type: 'left',
			unit: 'px',
			to: 0,
			step: 24,
			delay: 20
		};
		
		var panelAnimationParams = {
			type: 'left',
			unit: 'px',
			to: 0,
			step: 25,
			delay: 20
		};

		var statusLabelAnimationParams = {
			type: 'opacity',
			to: 100,
			step: 10,
			delay: 25,
			fadeOut: true,
			onfinish: function () {
				if (statusLabelAnimationParams.to == 0)
					statusLabelAnimationParams.to = 1000;
				else if (statusLabelAnimationParams.fadeOut) {
					statusLabelAnimationParams.to = 0;
					statusLabelAnimationParams.timerHandle = setTimeout(this.fxRun, 2000);
				}
			}
		};
		
		function logInOut(isLogIn) {
			
			/**
			 *	@param	keep	{Boolean}	true means keep the status label visible.
			 *								false means hide the status label after 2secs.
			 *								Default is false.
			 */
			function showLoginStatus(color, text, keep) {
				clearTimeout(statusLabelAnimationParams.timerHandle);
				if (statusLabelAnimationParams.to == 0)
					statusLabelAnimationParams.to = 100;
				statusLabelAnimationParams.fadeOut = !keep;
				loginStatusLabel.style.color = color;
				loginStatusLabel.innerHTML = text;
				loginStatusLabel.fxRun();
			}
			
			if (isLogIn) {
				if (usernameTextBox.value == '') {
					showLoginStatus('Red', 'Please enter the username.');
					return;
				}
				if (passwordTextBox.value == '') {
					showLoginStatus('Red', 'Please enter the password.');
					return;
				}
				
				showLoginStatus('Blue', 'Logging in...', true);
				loginButton.disabled = true;

				AJAX(SPost, 'TIUTracking.php', 'q=login&username=' + usernameTextBox.value + '&password=' + passwordTextBox.value, function () {
						if (this.readyState == 4 && this.status == 200) {
							if (this.responseText == 'OK') {
								showLoginStatus('Blue', '');
								isLoggedIn = true;
								updateUI();
							} else
								showLoginStatus('Red', this.responseText);
						} else
							showLoginStatus('Red', 'Error connecting to server.');
						loginButton.disabled = false;
					}, null
				);
			} else {
				AJAX(SPost, 'TIUTracking.php', 'q=logout', null);
				isLoggedIn = false;
				updateUI();
			}
		}
		currentRowIndex = -1;
		
		function updateUI() {
			var assetTableElement = assetTable.getElement();
			if (isLoggedIn) {
				$('usernameLabel').innerHTML = 'Hi <strong style="color: blue;">' + usernameTextBox.value + '</strong>';
				loggedInDialog.style.display = SBlock;
				loginDialog.style.display = SNone;
				usernameTextBox.value = '';
				passwordTextBox.value = '';
				
				for (var i = 0, row; i < assetTableElement.rows.length; i++) {
					row = assetTableElement.rows[i];

					var removeButton = newElement('div', 'DeleteButton');
					removeButton.linkedRow = row;
					removeButton.title = 'Delete this asset';
					removeButton.onclick = function (event) {
						if (currentRowIndex == -1) {
							currentRowIndex = this.linkedRow.rowIndex;
							if (confirm("You're about to delete this asset permanently.")) {
								AJAX(SPost, 'TIUTracking.php', 'q=del_asset&tagId=' + this.linkedRow.cells[0].innerHTML, function () {
									if (this.readyState == 4 && this.status == 200) {
										// The server returns the id of the deleted tag or 0 if none.
										var tagId = parseInt(this.responseText);
										if (tagId > 0) {
											var idx = currentRowIndex;
											assetTable.deleteRow(idx);
											assets.splice(idx, 1);
											map.removeEntity(idx);
										} else
											alert('Could not delete this asset. Please try again.');
										currentRowIndex = -1;
									}
								});
							}
						} else
							alert('Please wait for the current request to finish.');
						event.stopPropagation();
					}
					row.lastChild.innerHTML = '';
					row.lastChild.appendChild(removeButton);
				}
			} else {
				loginDialog.style.display = SBlock;
				loggedInDialog.style.display = SNone;
				
				for (var i = 0; i < assetTableElement.rows.length; i++)
					assetTableElement.rows[i].lastChild.innerHTML = '&nbsp;';
			}
		}
		
		function TMapEntity() {

			function entityScaleChange(scale) {
				this.style.left = (this.mX * scale - 12) + SPixel;
				this.style.top  = (this.mY * scale - this.offsetHeight) + SPixel;
			}
			
			function assetInfo () {
				return	'<table cellspacing="0" style="border-collapse: collapse;">' +
						'<tr><td>Tag ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mTagId + '</td></tr>' +
						'<tr><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mAssetId + '</td></tr>' +
						'<tr><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mBattery + '</td></tr></table>';
			}
			
			var entity = newElement(SDiv, 'TMapEntity');
			entity.onScaleChange = entityScaleChange;
			entity.getInfo = assetInfo;
			
			return entity;
		}
		
		function updateAssetInfo() {
			assetAjax.doSend('q=get_asset');
		}
		
		function update() {
			//ajax.open('GET', 'AssetInfo.php?id=', true);
			//ajax.send();
			var count = 10;
		
			function rowClick(event) {
				map.selectEntity(this.linkedEntity);
			}
			
			// Table header
			cssClasses = ['TagId', 'AssetId', 'X', 'Y', 'Battery', 'More'];
			
			// Fake asset.
			for (var i = 0, row, asset; i < count; i++) {
				row = assetTable.insertRow(-1);
				
				//asset = newElement(SDiv, 'TMapEntity');
				asset = TMapEntity();
				asset.appendChild(newElement(SDiv, 'TAssetIcon'));
				asset.mTagId = i + 1;
				asset.mAssetId = randomId();
				asset.mTimestamp = '2011-04-21 20:21:22';
				asset.mX = Math.round(23 * Math.random());
				asset.mY = Math.round(9 * Math.random());
				asset.mBattery = 'Normal';
				
				// Link the asset with the corresponding row the the asset table.
				asset.linkedTable = assetTable;
				asset.linkedRow = row;
				row.linkedEntity = asset;
				//row.addEventListener('click', rowClick, false);

				assets.push(asset);
				map.addEntity(asset);
				
				var cellValues = [asset.mTagId, asset.mAssetId, asset.mX, asset.mY, asset.mBattery, '&nbsp;'];
				for (var j = 0; j < cellValues.length; j++) {
					var cell = row.insertCell(-1);
					cell.innerHTML = cellValues[j];
					cell.className = 'Col ' + cssClasses[j];
				}
			}

			//assetTable.setMaxRowCount(10);
		}
		
		function randomId() {
			var result = '';
			var hexDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
			for (var i = 0; i < 2; i++) {
				for (var j = 0; j < 4 + i; j++) {
					result += hexDigits[Math.floor(Math.random() * 15)];
				}
				result += '-';
			}
			for (var j = 0; j < 6; j++) {
				result += hexDigits[Math.floor(Math.random() * 15)];
			}
			return result;
		}
		
		function adjusMapRect() {
			map.setRect(elTabPanel.offsetLeft + elTabPanel.offsetWidth, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
		}
		
		onresize = function () {
			adjusMapRect();
			elMapToolbar.style.left = (window.innerWidth - elMapToolbar.offsetWidth - 10) + SPixel;
			elMapToolbar.style.top  = (window.innerHeight - elMapToolbar.offsetHeight - 10) + SPixel;
			elTabPanel.style.height = (window.innerHeight - headerPanel.offsetHeight) + SPixel;
		}
		
		onload = function () {
			headerPanel = $('headerPanel');
			
			elTabPanel = $('elTabPanel');
			$fx(elTabPanel).fxAdd(panelAnimationParams);
			
			tabControl = new TTabControl(elTabPanel);
		
			loginDialog = $('loginDialog');
			usernameTextBox = $('usernameTextBox');
			passwordTextBox = $('passwordTextBox');
			loginButton = $('loginButton');
			loggedInDialog = $('loggedInDialog');
			loginStatusLabel = $('loginStatusLabel');
			$fx(loginStatusLabel).fxAdd(statusLabelAnimationParams);
		
			assetTable = new TFlexTable($('assetsTab'));
			assetTable.attachTextBox($('assetSearchBox'), 1);
			assetTable.onSelectChange = function () {
				var row = this.getSelectedRow();
				if (row)
					map.selectEntity(row.linkedEntity);
				else
					map.selectEntity(null);
			}
			
			detectorTable = new TFlexTable($('detectorsTab'));
			detectorTable.attachTextBox($('detectorSearchBox'));
			
			elMapToolbar = $('elMapToolbar');
			
			map = new TMap();
			map.onLoad = function () {
				elMapToolbar.style.visibility = SVisible;
			}
			map.onSelectChange = function () {
				var entity = this.getSelectedEntity();
				if (entity)
					entity.linkedTable.setSelectedIndex(entity.linkedRow.rowIndex);
				else {
					assetTable.setSelectedIndex(-1);
					detectorTable.setSelectedIndex(-1);
				}
			}
			
			elMapImage = new Image();
			elMapImage.src = 'images/FloorPlan.jpg';
			elMapImage.onload = function () {
				map.setMapImage(this, 120);
			}

			assetInfoUpdateTimer = new TTimer(5000, updateAssetInfo});
			assetInfoUpdateTimer.setEnabled(true);
			
			updateAssetInfo();
			
			/*------------------------------------*/
			
			var button = $('showHideTabPanelButton');
			button.style.left = (elTabPanel.offsetWidth - button.offsetWidth - 3) + SPixel;
			button.style.top  = (elTabPanel.offsetTop + 3) + SPixel;
			button.onclick = function () {
				if (this.offsetLeft > 0) {
					this.innerHTML = '»';
					this.className = 'TextIcon TCastShadow';
					this.title = 'Show panel';

					panelAnimationParams.to = -elTabPanel.offsetWidth;
					panelAnimationParams.onfinish = null;

					buttonAnimationParams.to = 0;

					map.setRect(0, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
				} else {
					this.innerHTML = '«';
					this.className = 'TextIcon';
					this.title = 'Hide panel';
					
					panelAnimationParams.to = 0;
					panelAnimationParams.onfinish = adjusMapRect;
				
					buttonAnimationParams.to = elTabPanel.offsetWidth - this.offsetWidth - 3;
				}
		
				elTabPanel.fxRun();
				this.fxRun();
			}
			$fx(button).fxAdd(buttonAnimationParams);
			
			$('showAssetsCheckBox').onchange = function () {
				var v = this.checked ? SVisible : SHidden;
				tabControl.setTabVisible(1, this.checked);
				for (var i = 0; i < assets.length; i++)
					assets[i].style.visibility = v;
			}
			
			$('showDetectorsCheckBox').onchange = function () {
				tabControl.setTabVisible(2, this.checked);
				for (var i = 0; i < detectors.length; i++)
					detectors[i].style.visibility = v;
			}
			/*
			$('showGridCheckBox').onchange = function () {
				$('gridSpacingTextBox').disabled = !this.checked;
			}
			*/

			onresize();
		}
	</script>
	<link href="TIUTracking.css" rel="stylesheet" type="text/css"/>
	<script type="application/x-javascript" src="js/Common.js"></script>
	<script type="application/x-javascript" src="js/FlexTable.js"></script>
	<script type="application/x-javascript" src="js/InfoBox.js"></script>
	<script type="application/x-javascript" src="js/Map.js"></script>
	<script type="application/x-javascript" src="js/TabControl.js"></script>
	<script type="application/x-javascript" src="js/Timer.js"></script>
	<script type="application/x-javascript" src="js/Vector2D.js"></script>
	<script type="application/x-javascript" src="js/fx-source.js"></script>
</head>
<body>
	<div id="headerPanel" class="TCastShadow" style="text-align: center;">
		Asset Tracking System
	</div>
	<button id="showHideTabPanelButton" class="TextIcon" title="Hide panel" style="position: absolute; z-index: 4; padding: 0 4px 2px;">«</button>
	<div id="elTabPanel" class="TTabPanel TCastShadow" style="	position: relative; left: 0; top: 0; margin: 0; padding: 0; z-index: 2; background-color: #FFF; width: 350px;">		
		<ul class="TTabNamePanel">
			<li class="TTabName">Settings</li>
			<li class="TTabName">&nbsp;&nbsp;Assets&nbsp;&nbsp;&nbsp;</li>
			<li class="TTabName">Detectors</li>
		</ul>
		<div class="TTabContentPanel">
			<div id="settingsTab" class="TTabContent" style="vertical-align: middle;">
				<fieldset id="loginDialog" class="HasBorder">
					<legend>Login</legend>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Username:</div><input id="usernameTextBox" type="textbox" maxlength="30" style="width: 150px;" /><br /></div>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Password:</div><input id="passwordTextBox" type="password" maxlength="30" style="width: 150px;" /><br /></div>
					<div><button id="loginButton" onclick="logInOut(true);">Log in</button><label id="loginStatusLabel" style="margin-left: 35px; opacity: 0;"></label></div>
				</fieldset>
				<div id="loggedInDialog" style="display: none;">
					<label id="usernameLabel" style="padding: 0 1em 0 0;"></label>
					<a id="logOutLink" href="javascript:logInOut(false);" style="padding: 0 1em; border-left: 1px solid #CCC;">Log out</a>
				</div>
				<br />
				<fieldset class="HasBorder">
					<legend>Options</legend>
					<input id="showAssetsCheckBox" type="checkbox" checked /><label for="showAssetsCheckBox">Show assets</label><br />
					<input id="showDetectorsCheckBox" type="checkbox" checked /><label for="showDetectorsCheckBox">Show detectors</label><br />
					<!--<input id="showGridCheckBox" type="checkbox" /><label for="showGridCheckBox">Show grid</label><div style="float: right;"><label>Grid spacing</label><input id="gridSpacingTextBox" type="textbox" value="1" disabled style="margin-left: 10px; width: 40px;" /></div><br />-->
				</fieldset>
			</div>
			<div id="assetsTab" class="TTabContent">
				<input type="textbox" id="assetSearchBox" class="TSearchBox" placeholder="Search for an asset"/>
				<div class="TableHeader"><div class="Col TagId">Tag ID</div><div class="Col AssetId">Asset ID</div><div class="Col X">X</div><div class="Col Y">Y</div><div class="Col Battery">Battery</div><div class="Col More"></div></div>
			</div>
			<div id="detectorsTab" class="TTabContent">
				<input type="textbox" id="detectorSearchBox" class="TSearchBox" placeholder="Search for a detector"/>
				<table id="elDetectorTable"></table>
			</div>
		</div>
	</div>
	<div id="elMapToolbar" class="TCastShadow">
		<button id="zoomOutButton" class="LeftPill TextIcon Translucent" title="Zoom out" onclick="map.zoom(null, 0.5);">-</button>
		<button id="zoomFitButton" class="Middle TextIcon Translucent" title="Zoom fit" onclick="map.zoom(null, 0);">[]</button>
		<button id="zoomInButton" class="RightPill TextIcon Translucent" title="Zoom in" onclick="map.zoom(null, 2);">+</button>
	</div>
</body>
</html>