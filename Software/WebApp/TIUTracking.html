<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Asset Tracking System</title>
	<link rel="shortcut icon" href= "favicon.ico">
	<script type="application/x-javascript">
		/**
		 *	Creates an AJAX object with 3 custom attributes (mMethod, mUrl, and doSend()).
		 *
		 *	@param	method	{String}	'GET' or 'POST'.
		 *	@param	url		{String}	The request url.
		 *	@param	callback	{Function}	The function to be called upon receiving the response.
		 */
		function AJAX(method, url, callback) {

			/**
			 *	Sends request with certain params.
			 *
			 *	@param	params	{String}	Params to send along, e.g. 'username=abc&password=123'
			 */
			function doSend(params) {
				try {
					if (this.mMethod == 'POST') {
						this.open(this.mMethod, this.mUrl, true);
						this.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
						this.send(params);
					} else {

						this.open(this.mMethod, this.mUrl + '?' + params, true);
						this.send();
					}
				} catch (e) {
					console.log('AJAX failed');
				}
			}
				
			var xhr = new XMLHttpRequest();
			xhr.mMethod = method;
			xhr.mUrl = url;
			xhr.onreadystatechange = callback;
			xhr.doSend = doSend;

			return xhr;
		}
				
		var headerPanel;
		var tabControl;
		var tabPanel;
		
		var map;
		var mapImage;
		var mapToolbar;
		
		var tags = [];
		var tagTable;
		
		var detectors = [];
		var detectorTable;
		
		/**
		 *	The table that has a row selected, either @tagTable or @detectorTable, exclusively.
		 */
		var activeTable;
		
		var assetInfoUpdateTimer;
		
		var loginDialog;
		var usernameTextBox;
		var passwordTextBox;
		var loginButton;
		var statusLabel;
		var loggedInDialog;
		
		var isLoggedIn = false;
		
		var buttonAnimationParams = {
			type: 'left',
			unit: 'px',
			to: 0,
			step: 24,
			delay: 20
		};
		
		var panelAnimationParams = {
			type: 'left',
			unit: 'px',
			to: 0,
			step: 25,
			delay: 20
		};

		var statusLabelAnimationParams = {
			type: 'opacity',
			to: 100,
			step: 10,
			delay: 25,
			fadeOut: true,
			onfinish: function () {
				if (statusLabelAnimationParams.to == 0)
					statusLabelAnimationParams.to = 100;
				else if (statusLabelAnimationParams.fadeOut) {
					statusLabelAnimationParams.to = 0;
					statusLabelAnimationParams.timerHandle = setTimeout(this.fxRun, 2000);
				}
			}
		};
		
		
		/**
		 *	@param	fadeOut	{Boolean}	true means keep the status label visible.
		 *								false means hide the status label after 2secs.
		 *								Default is false.
		 */
		function showStatus(color, text, fadeOut) {
			clearTimeout(statusLabelAnimationParams.timerHandle);
			if (statusLabelAnimationParams.to == 0)
				statusLabelAnimationParams.to = 100;
			statusLabelAnimationParams.fadeOut = fadeOut;
			statusLabel.style.color = color;
			statusLabel.innerHTML = text;
			statusLabel.fxRun();
		}

		var BatteryStatus = ['Normal', 'Low!'];

		var deleteRowIndex = -1;

		/**
		 *	An AJAX object responsible for communicating with the server.
		 */
		var tagRequestManager = AJAX('POST', 'TIUTracking.php', function () {
			if (this.readyState == 4 && this.status == 200) {
				/*
					Data returned are in JSON format.
				{	
					request: String,			// 'login', 'get-tags', 'add-tag', 'del-tag', 'get-detectors', 'add-detector', 'del-detector'
					status:	Integer,			// 0 for no error
					data: RequestSpecificData	// The returned data, if status <> 0, this will be an error message.
				}
				*/
				loginButton.disabled = false;
				try {
					var response = eval(this.responseText);
					
					if (!response)
						return;
					
					if (response.status != 0) {
						showStatus('Red', response.data, true);
						return;
					}
					
					switch (response.request) {
						case 'login':
							showStatus('Blue', '', true);
							updateUI(true);
							break;
						
						case 'get-tags':
							var columnNames = ['Id', 'AssetId', 'X', 'Y', 'Battery', 'More'];
							var newTagCount = response.data.length - 1;
							var curTagCount = tags.length;
							
							// Someone else might have deleted some tags.
							if (newTagCount < curTagCount) {
								for (var i = curTagCount - 1; i >= newTagCount; i--) {
									map.removeEntity(tags[i]);
									tagTable.deleteRow(-1);
									tags[i] = null;
								}
							}
							
							tags.length = newTagCount;
							
							var row, tag, tagData, cellValues;
							for (var i = 0; i < newTagCount; i++) {
								
								tagData = response.data[i];
								tagData.b = BatteryStatus[tagData.b];
								cellValues = [tagData.t, tagData.a, tagData.x.toFixed(1), tagData.y.toFixed(1), tagData.b, '&nbsp;'];
								
								// If the tag hasn't been created, we need to create it
								// and add it to the table and the map.
								if (!tags[i]) {
									tag = TMapEntity('TTag');
									tags[i] = tag;
									map.addEntity(tag);
									row = tagTable.insertRow(-1);
									for (var j = 0; j < cellValues.length; j++) {
										var cell = row.insertCell(-1);
										cell.innerHTML = cellValues[j];
										cell.className = 'Col ' + columnNames[j];
									}									
								} else {
									tag = tags[i];
									row = tagTable.rows[i];
									for (var j = 0; j < cellValues.length; j++) {
										var cell = row.cells[j];
										cell.innerHTML = cellValues[j];
									}
								}
								
								row.mLinkedEntity = tag;

								tag.mTimestamp	= tagData.s;
								tag.mId			= tagData.t;
								tag.mAssetId	= tagData.a;
								tag.mX			= tagData.x;
								tag.mY			= tagData.y;
								tag.mBattery	= tagData.b;
								tag.mLinkedRow	= row;
								tag.mLinkedTable = tagTable;
								
								map.invalidate();
							}
							break;
						
						case 'add-tag':
							
							break;
						
						case 'del-tag':
							tagTable.deleteRow(deleteRowIndex);
							map.removeEntity(tags.splice(deleteRowIndex, 1)[0]);
							deleteRowIndex = -1;
					}
				} catch (e) {
					console.log(e);
				}
			}
		});
		
		var detectorRequestManager = AJAX('POST', 'TIUTracking.php', function () {
			if (this.readyState == 4 && this.status == 200) {
				try {
					var response = eval(this.responseText);
					
					if (!response)
						return;
					
					if (response.status != 0) {
						showStatus('Red', response.data, true);
						return;
					}
					
					switch (response.request) {
						case 'get-detectors':
							var columnNames = ['Id', 'X', 'Y', 'Battery', 'More'];
							var newDetectorCount = response.data.length - 1;
							var curDetectorCount = detectors.length;
							
							// Someone else might have deleted some detectors.
							if (newDetectorCount < curDetectorCount) {
								for (var i = curDetectorCount - 1; i >= newDetectorCount; i--) {
									map.removeEntity(detectors[i]);
									detectorTable.deleteRow(-1);
									detectors[i] = null;
								}
							}
							
							detectors.length = newDetectorCount;
							
							var row, detector, detectorData, cellValues;
							for (var i = 0; i < newDetectorCount; i++) {
								
								detectorData = response.data[i];
								detectorData.b = BatteryStatus[detectorData.b];
								cellValues = [detectorData.d, detectorData.x.toFixed(1), detectorData.y.toFixed(1), detectorData.b, '&nbsp;'];
								
								// If the detector hasn't been created, we need to create it
								// and add it to the table and the map.
								if (!detectors[i]) {
									detector = TMapEntity('TDetector');
									detectors[i] = detector;
									map.addEntity(detector);
									row = detectorTable.insertRow(-1);
									for (var j = 0; j < cellValues.length; j++) {
										var cell = row.insertCell(-1);
										cell.innerHTML = cellValues[j];
										cell.className = 'Col ' + columnNames[j];
									}									
								} else {
									detector = detectors[i];
									row = detectorTable.rows[i];
									for (var j = 0; j < cellValues.length; j++) {
										var cell = row.cells[j];
										cell.innerHTML = cellValues[j];
									}
								}
								
								row.mLinkedEntity = detector;

								detector.mId			= detectorData.d;
								detector.mX				= detectorData.x;
								detector.mY				= detectorData.y;
								detector.mBattery		= detectorData.b;
								detector.mLinkedRow		= row;
								detector.mLinkedTable 	= detectorTable;
								
								map.invalidate();
							}
							break;
						
						case 'add-detector':
							
							break;
						
						case 'del-detector':
							detectorTable.deleteRow(deleteRowIndex);
							map.removeEntity(detectors.splice(deleteRowIndex, 1)[0]);
							deleteRowIndex = -1;
					}
				} catch (e) {
					console.log(e);
				}
			}
		});
		
		function login() {
			if (usernameTextBox.value == '') {
				showStatus('Red', 'Please enter the username.', true);
				return;
			}
			if (passwordTextBox.value == '') {
				showStatus('Red', 'Please enter the password.', true);
				return;
			}
			
			showStatus('Blue', 'Logging in...', false);
			loginButton.disabled = true;

			tagRequestManager.doSend('request=login&username=' + usernameTextBox.value + '&password=' + passwordTextBox.value);		
		}
		
		function logout() {
			tagRequestManager.doSend('request=logout');
			updateUI(false);		
		}

				
		/* TEntityType */
		var etTag		= 'tag';
		var etDetector	= 'detector';
		var EntityTypes = [etTag, etDetector];
		
		/**
		 *	Creates a remove button. The button can be added to the tag table or the detector table.
		 *
		 *	@param	entityType	{TEntityType}
		 *	@param	linkedTable	{HTMLTableElement}	The table that owns this button.
		 *	@param	linkedRow	{HTMLRowElement}	The row that owns this button.
		 */
		function createRemoveButton(entityType, linkedTable, linkedRow) {
			
			function buttonClick(event) {
				if (deleteRowIndex == -1) {
					deleteRowIndex = this.mLinkedRow.rowIndex;
					var t = this.mEntityType;
					if (confirm('Delete this ' + t + ' permanently?')) {
						var mngr = this.mEntityType == etTag ? tagRequestManager : detectorRequestManager;
						mngr.doSend('request=del-' + t + '&' + t + '-id=' + this.mLinkedRow.mLinkedEntity.mId);
					}
				} else
					showStatus('Red', 'Please wait for the current request to finish.', true);
				event.stopPropagation();
			}
			
			var b = newElement(SDiv, 'DeleteButton');
			b.mEntityType = entityType;
			b.mLinkedTable = linkedTable;
			b.mLinkedRow = linkedRow;
			b.onclick = buttonClick;
			b.title = 'Delete';
			
			return b;
		}
		
		function updateUI(loggedIn) {
			if (isLoggedIn == loggedIn)
				return;
			
			var tables = [tagTable.getElement(), detectorTable.getElement()];
			
			for (var i = 0; i < tables.length; i++) {
				var table = tables[i];
				if (loggedIn) {
					$('usernameLabel').innerHTML = 'Hi <strong style="color: blue;">' + usernameTextBox.value + '</strong>';
					loggedInDialog.style.display = SBlock;
					loginDialog.style.display = SNone;
					usernameTextBox.value = '';
					passwordTextBox.value = '';
					
					for (var j = 0, row; j < table.rows.length; j++) {
						row = table.rows[j];
						row.lastChild.innerHTML = '';
						row.lastChild.appendChild(createRemoveButton(EntityTypes[i], table, row));
					}
				} else {
					loginDialog.style.display = SBlock;
					loggedInDialog.style.display = SNone;
					
					for (var j = 0; j < table.rows.length; j++)
						table.rows[j].lastChild.innerHTML = '&nbsp;';
				}
			}
			
			isLoggedIn = loggedIn;
		}
		
		function TMapEntity(className) {

			function entityScaleChange(scale) {
				// First child is the marker icon.
				this.style.left = (this.mX * scale - this.firstChild.offsetWidth * 0.5) + SPixel;
				this.style.top  = (this.mY * scale - this.offsetHeight) + SPixel;
			}
			
			function assetInfo() {
				return	'<table cellspacing="0" style="border-collapse: collapse; width: 100%;">' +
						'<caption style="color: Red; font-weight: bold;">Tag</caption>' +
						'<tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mId + '</td></tr>' +
						'<tr style="border: none;"><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mAssetId + '</td></tr>' +
						'<tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mBattery + '</td></tr></table>';
			}
			
			function detectorInfo() {
				return	'<table cellspacing="0" style="border-collapse: collapse; width: 100%;">' +
						'<caption style="color: Red; font-weight: bold;">Detector</caption>' +
						'<tr style="border-top: 1px solid #DFDFDF; border-bottom: none;"><td>ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mId + '</td></tr>' +
						//'<tr><td>Asset ID</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mAssetId + '</td></tr>' +
						'<tr style="border: none"><td>Battery</td><td>&nbsp;:&nbsp;</td><td style="font-weight: bold;">' + this.mBattery + '</td></tr></table>';
			}
			
			var entity = newElement(SDiv, 'TMapEntity');
			
			// Add the marker icon.
			entity.appendChild(newElement(SDiv, className));
			
			entity.onScaleChange = entityScaleChange;
			
			if (className == 'TTag')
				entity.getInfo = assetInfo;
			else
				entity.getInfo = detectorInfo;
			
			return entity;
		}
		
		function updateAssetInfo() {
			tagRequestManager.doSend('request=get-tags');
		}

		function adjusMapRect() {
			map.setRect(tabPanel.offsetLeft + tabPanel.offsetWidth, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
		}
		
		onresize = function () {
			adjusMapRect();
			mapToolbar.style.left = (window.innerWidth - mapToolbar.offsetWidth - 10) + SPixel;
			mapToolbar.style.top  = (window.innerHeight - mapToolbar.offsetHeight - 10) + SPixel;
			tabPanel.style.height = (window.innerHeight - headerPanel.offsetHeight) + SPixel;
		}
		
		onload = function () {
			headerPanel = $('headerPanel');
			
			tabPanel = $('tabPanel');
			$fx(tabPanel).fxAdd(panelAnimationParams);
			
			tabControl = new TTabControl(tabPanel);
		
			loginDialog = $('loginDialog');
			usernameTextBox = $('usernameTextBox');
			passwordTextBox = $('passwordTextBox');
			loginButton = $('loginButton');
			loggedInDialog = $('loggedInDialog');
			statusLabel = $('statusLabel');
			$fx(statusLabel).fxAdd(statusLabelAnimationParams);
		
			function tableSelectChange() {
				var row = this.getSelectedRow();
				if (this == activeTable || row != null) {
					var entity = row ? row.mLinkedEntity : null;
					map.selectEntity(entity);
				}
			}
			
			tagTable = new TFlexTable($('assetsTab'));
			tagTable.attachTextBox($('assetSearchBox'), 1);
			tagTable.onSelectChange = tableSelectChange;
			
			detectorTable = new TFlexTable($('detectorsTab'));
			detectorTable.attachTextBox($('detectorSearchBox'), 0);
			detectorTable.onSelectChange = tableSelectChange;
			
			// Imporant!
			activeTable = tagTable;
			
			mapToolbar = $('mapToolbar');
			
			map = new TMap();
			map.onLoad = function () {
				mapToolbar.style.visibility = SVisible;
			}
			map.onSelectChange = function () {
				var idx = -1;
				var e = this.getSelectedEntity();
				if (e) {
					var n = e.mLinkedTable;
					if (activeTable != n) {
						var c = activeTable;
						activeTable = n;
						c.setSelectedIndex(-1);
					}
					idx = e.mLinkedRow.rowIndex;
				}
				activeTable.setSelectedIndex(idx);
			}
			map.onClick = function (x, y) {
				$('detectorX').value = x.toFixed(1);
				$('detectorY').value = y.toFixed(1);
			}
			
			mapImage = new Image();
			mapImage.src = 'images/FloorPlan.jpg';
			mapImage.onload = function () {
				map.setMapImage(this, 120);
			}

			//assetInfoUpdateTimer = new TTimer(5000, updateAssetInfo);
			//assetInfoUpdateTimer.setEnabled(true);
			
			updateAssetInfo();
			detectorRequestManager.doSend('request=get-detectors');

			/*------------------------------------*/
			
			var button = $('showHideTabPanelButton');
			button.style.left = (tabPanel.offsetWidth - button.offsetWidth - 3) + SPixel;
			button.style.top  = (tabPanel.offsetTop + 3) + SPixel;
			button.onclick = function () {
				if (this.offsetLeft > 0) {
					this.innerHTML = '»';
					this.className = 'TextIcon TCastShadow';
					this.title = 'Show panel';

					panelAnimationParams.to = -tabPanel.offsetWidth;
					panelAnimationParams.onfinish = null;

					buttonAnimationParams.to = 0;

					map.setRect(0, headerPanel.offsetHeight, window.innerWidth, window.innerHeight);
				} else {
					this.innerHTML = '«';
					this.className = 'TextIcon';
					this.title = 'Hide panel';
					
					panelAnimationParams.to = 0;
					panelAnimationParams.onfinish = adjusMapRect;
				
					buttonAnimationParams.to = tabPanel.offsetWidth - this.offsetWidth - 3;
				}
		
				this.fxRun();
				tabPanel.fxRun();
			}
			$fx(button).fxAdd(buttonAnimationParams);
			
			function showEntityGroup(className, entities, visible) {
				// Hides the info box if the selected entity is in this group.
				var e = map.getSelectedEntity();
				if (e && e.firstChild.className == className)
					map.selectEntity(null);
				
				var v = visible ? SVisible : SHidden;
				var i = className == 'TTag' ? 1 : 2;
				tabControl.setTabVisible(i, visible);
				for (var i = 0; i < entities.length; i++)
					entities[i].style.visibility = v;				
			}
			
			$('showAssetsCheckBox').onchange = function () {
				showEntityGroup('TTag', tags, this.checked);
			}
			
			$('showDetectorsCheckBox').onchange = function () {
				showEntityGroup('TDetector', detectors, this.checked);
			}

			onresize();
		}
	</script>
	<link href="TIUTracking.css" rel="stylesheet" type="text/css"/>
	<script type="application/x-javascript" src="js/Common.js"></script>
	<script type="application/x-javascript" src="js/FlexTable.js"></script>
	<script type="application/x-javascript" src="js/InfoBox.js"></script>
	<script type="application/x-javascript" src="js/Map.js"></script>
	<script type="application/x-javascript" src="js/TabControl.js"></script>
	<script type="application/x-javascript" src="js/Timer.js"></script>
	<script type="application/x-javascript" src="js/Vector2D.js"></script>
	<script type="application/x-javascript" src="js/fx-source.js"></script>
</head>
<body>
	<div id="headerPanel" class="TCastShadow" style="text-align: center;">
		Asset Tracking System
	</div>
	<button id="showHideTabPanelButton" class="TextIcon" title="Hide panel" style="position: absolute; z-index: 4; padding: 0 4px 2px;">«</button>
	<div id="tabPanel" class="TTabPanel TCastShadow" style="	position: relative; left: 0; top: 0; margin: 0; padding: 0; z-index: 2; background-color: #FFF; width: 350px;">		
		<ul class="TTabNamePanel">
			<li class="TTabName">Welcome</li>
			<li class="TTabName">&nbsp;&nbsp;Assets&nbsp;&nbsp;&nbsp;</li>
			<li class="TTabName">Detectors</li>
		</ul>
		<div class="TTabContentPanel">
			<div id="welcomeTab" class="TTabContent" style="vertical-align: middle;">
				<fieldset id="loginDialog">
					<legend>Admin</legend>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Username:</div><input id="usernameTextBox" type="textbox" maxlength="30" style="width: 150px;" /><br /></div>
					<div style="margin-bottom: 0.5em;"><div style="float: left; width: 80px;">Password:</div><input id="passwordTextBox" type="password" maxlength="30" style="width: 150px;" /><br /></div>
					<div><button id="loginButton" onclick="login();">Log in</button><label id="statusLabel" style="margin-left: 35px; opacity: 0;"></label></div>
				</fieldset>
				<div id="loggedInDialog" style="display: none;">
					<label id="usernameLabel" style="padding: 0 1em 0 0;"></label>
					<a id="logOutLink" href="javascript:logout();" style="padding: 0 1em; border-left: 1px solid #CCC;">Log out</a>
				</div>
				<br />
				<fieldset>
					<legend>Options</legend>
					<input id="showAssetsCheckBox" type="checkbox" checked /><label for="showAssetsCheckBox">Show tags</label><br />
					<input id="showDetectorsCheckBox" type="checkbox" checked /><label for="showDetectorsCheckBox">Show detectors</label><br />
					<!--<input id="showGridCheckBox" type="checkbox" /><label for="showGridCheckBox">Show grid</label><div style="float: right;"><label>Grid spacing</label><input id="gridSpacingTextBox" type="textbox" value="1" disabled style="margin-left: 10px; width: 40px;" /></div><br />-->
				</fieldset>
			</div>
			<div id="assetsTab" class="TTabContent">
				<input type="textbox" id="assetSearchBox" class="TSearchBox" placeholder="Search for an asset"/>
				<div class="TableHeader"><div class="Col Id">ID</div><div class="Col AssetId">Asset ID</div><div class="Col X">X</div><div class="Col Y">Y</div><div class="Col Battery">Battery</div><div class="Col More"></div></div>
			</div>
			<div id="detectorsTab" class="TTabContent">
				<fieldset>
					<legend>Add new detector</legend>
					<label>X :</label><input type="textbox" id="detectorX" style="width: 30px; text-align: right;" /><br />
					<label>Y :</label><input type="textbox" id="detectorY" style="width: 30px; text-align: right;" /><br />
					<label>Click on the map to place the detector</label>
				</fieldset>
				<br/>
				<input type="textbox" id="detectorSearchBox" class="TSearchBox" placeholder="Search for a detector"/>
				<div class="TableHeader"><div class="Col Id">ID</div><div class="Col X">X</div><div class="Col Y">Y</div><div class="Col Battery">Battery</div><div class="Col More"></div></div>
			</div>
		</div>
	</div>
	<div id="mapToolbar" class="TCastShadow">
		<button id="zoomOutButton" class="LeftPill TextIcon Translucent" title="Zoom out" onclick="map.zoom(null, 0.5);">-</button>
		<button id="zoomFitButton" class="Middle TextIcon Translucent" title="Zoom fit" onclick="map.zoom(null, 0);">[]</button>
		<button id="zoomInButton" class="RightPill TextIcon Translucent" title="Zoom in" onclick="map.zoom(null, 2);">+</button>
	</div>
</body>
</html>